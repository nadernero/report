<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الخدمة بالكنيسة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo for Arabic text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- SheetJS (xlsx) library for Excel file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for statistics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF and html2canvas for exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* IMPROVEMENT: Using CSS Variables for easier theming */
        :root {
            --color-primary: #06b6d4;
            --color-primary-dark: #0891b2;
            --color-primary-darker: #0e7490;
            --color-primary-light: #ccfbf1;
            --color-primary-text: #115e59;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #f8fafc;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1d5db' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .dark body {
            background-color: #0f172a;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23334155' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .hidden-view { display: none !important; }
        #mainDashboard.hidden-view { display: none !important; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link.active { 
            background-color: var(--color-primary);
            color: white; 
            border-right: 4px solid var(--color-primary-darker);
        }
        .sidebar-link:hover {
            background-color: var(--color-primary-light);
            color: var(--color-primary-text);
        }
        .dark .sidebar-link.active {
             background-color: var(--color-primary-darker);
        }
        .dark .sidebar-link:hover {
            background-color: #134e4a; /* teal-900 */
            color: var(--color-primary-light);
        }
        .activity-btn.active, .friday-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 2px solid var(--color-primary-darker);
        }
        .report-tab.active {
            border-color: var(--color-primary);
            background-color: var(--color-primary);
            color: white;
        }
        input[type="date"]:required:invalid::-webkit-datetime-edit { color: transparent; }
        input[type="date"]:focus::-webkit-datetime-edit { color: black !important; }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .page-content {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="loadingOverlay" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="loader"></div>
    </div>
    
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <!-- Login/Services View -->
    <div id="loginOrServicesView">
        <div class="container mx-auto px-4 py-8 md:py-12">
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-500 to-teal-500">نظام إدارة الخدمة بالكنيسة</h1>
                <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">اختر الخدمة التي تريد الدخول إليها</p>
            </header>
            <main id="servicesGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8">
                <!-- Service Cards populated by JS -->
            </main>
        </div>
    </div>

    <!-- Main Dashboard View (Initially Hidden) -->
    <div id="mainDashboard" class="hidden-view">
        <div class="flex h-screen bg-gray-100 dark:bg-gray-800">
            <!-- Sidebar -->
            <nav id="sidebar" class="fixed md:relative inset-y-0 right-0 z-30 w-64 bg-white dark:bg-gray-900 shadow-lg flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
                <div class="p-4 border-b dark:border-gray-700 text-center">
                    <h2 class="text-xl font-bold text-cyan-600 dark:text-cyan-400">قائمة التحكم</h2>
                    <p id="sidebarServiceName" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <div id="sidebarLinks" class="flex-grow pt-4">
                    <a href="#" data-page="homePage" class="sidebar-link active flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-tachometer-alt ml-3 w-6 text-center"></i> لوحة المعلومات</a>
                    <a href="#" data-page="servantsPage" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-users ml-3 w-6 text-center"></i> إدارة الخدام</a>
                    <a href="#" data-page="attendancePage" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-check-square ml-3 w-6 text-center"></i> تسجيل الحضور</a>
                    <a href="#" data-page="reportsPage" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-chart-pie ml-3 w-6 text-center"></i> التقارير والإحصائيات</a>
                </div>
                <div class="p-4 border-t dark:border-gray-700 space-y-2">
                    <button id="backToServices" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                        <i class="fas fa-arrow-right-from-bracket ml-2"></i> العودة للخدمات
                    </button>
                    <button id="logoutBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">تسجيل الخروج</button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-y-auto">
                <header class="md:hidden flex justify-between items-center p-4 bg-white dark:bg-gray-900 shadow-md sticky top-0 z-10">
                    <button id="hamburgerBtn" class="text-2xl text-gray-700 dark:text-gray-300" aria-label="فتح القائمة الجانبية">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 id="mobilePageTitle" class="text-lg font-bold text-cyan-600"></h1>
                </header>

                <div class="p-6 md:p-10 flex-1">
                    <!-- Page: Home / Dashboard -->
                    <div id="homePage" class="page-content">
                        
                        <!-- Service-specific Dashboard -->
                        <div id="serviceDashboardContainer">
                             <h1 class="text-3xl font-bold mb-6">لوحة معلومات الخدمة</h1>
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex items-center gap-4">
                                    <i class="fas fa-users text-4xl text-cyan-500"></i>
                                    <div>
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">إجمالي الخدام</p>
                                        <p id="totalServantsStat" class="text-3xl font-bold">0</p>
                                    </div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex items-center gap-4">
                                    <i class="fas fa-birthday-cake text-4xl text-pink-500"></i>
                                    <div>
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">أقرب عيد ميلاد</p>
                                        <p id="upcomingBirthdayStat" class="text-lg font-bold">لا يوجد</p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                    <h2 class="text-xl font-bold mb-4">متوسط الحضور (آخر 30 يوم)</h2>
                                    <div class="relative h-80">
                                        <canvas id="homeAttendanceChart"></canvas>
                                    </div>
                                </div>
                                <div class="space-y-6">
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                        <h2 class="text-xl font-bold mb-4">إجراءات سريعة</h2>
                                        <div class="space-y-3">
                                            <button id="quickAddServant" class="w-full text-left p-3 rounded-lg bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800 transition-colors"><i class="fas fa-user-plus w-6 ml-2"></i> إضافة خادم جديد</button>
                                            <button id="quickGoToAttendance" class="w-full text-left p-3 rounded-lg bg-cyan-100 dark:bg-cyan-900 text-cyan-800 dark:text-cyan-200 hover:bg-cyan-200 dark:hover:bg-cyan-800 transition-colors"><i class="fas fa-check-square w-6 ml-2"></i> تسجيل الحضور</button>
                                        </div>
                                    </div>
                                    <div id="backupRestoreSection" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                        <h2 class="text-xl font-bold mb-4">النسخ الاحتياطي</h2>
                                        <div class="flex flex-col md:flex-row gap-3">
                                            <button id="backupBtn" class="w-full flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center justify-center gap-2"><i class="fas fa-download"></i> حفظ</button>
                                            <button id="restoreBtn" class="w-full flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center justify-center gap-2"><i class="fas fa-upload"></i> استرجاع</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Admin-specific Dashboard -->
                        <div id="adminDashboardContainer" class="hidden-view">
                            <h1 class="text-3xl font-bold mb-6">لوحة المعلومات الشاملة (الأمين العام)</h1>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Left Column: Stats and Chart -->
                                <div class="lg:col-span-1 space-y-6">
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex items-center gap-4">
                                        <i class="fas fa-users text-4xl text-cyan-500"></i>
                                        <div>
                                            <p class="text-gray-500 dark:text-gray-400 text-sm">إجمالي الخدام (كل الخدمات)</p>
                                            <p id="adminTotalServantsStat" class="text-3xl font-bold">0</p>
                                        </div>
                                    </div>
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                        <h2 class="text-xl font-bold mb-4">متوسط الحضور العام (آخر 30 يوم)</h2>
                                        <div class="relative h-80">
                                            <canvas id="adminAttendanceChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <!-- Right Column: All Servants Table -->
                                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                     <div class="flex flex-col md:flex-row gap-4 mb-4">
                                        <div class="relative flex-grow">
                                            <input type="text" id="adminSearchInput" placeholder="ابحث بالاسم أو الموبايل..." class="w-full p-3 pr-10 rounded-lg bg-gray-50 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 focus:border-cyan-500 focus:outline-none">
                                            <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        </div>
                                    </div>
                                    <div class="overflow-y-auto max-h-[500px]">
                                        <table class="w-full text-right">
                                            <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                                <tr>
                                                    <th class="p-3 font-bold">الاسم</th>
                                                    <th class="p-3 font-bold">الخدمة</th>
                                                    <th class="p-3 font-bold">الموبايل</th>
                                                </tr>
                                            </thead>
                                            <tbody id="adminServantsTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Page: Servants Management -->
                    <div id="servantsPage" class="page-content hidden-view">
                         <h1 class="text-3xl font-bold mb-6">إدارة الخدام</h1>
                         <div id="birthdayAlertsContainer" class="mb-6"></div>
                        <div id="servantsActions" class="flex flex-col md:flex-row gap-4 mb-6">
                            <div class="relative flex-grow">
                                <input type="text" id="searchInput" placeholder="ابحث بالاسم أو الموبايل..." class="w-full p-3 pr-10 rounded-lg bg-white dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 focus:border-cyan-500 focus:outline-none">
                                <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button id="addManualBtn" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:shadow-lg transition-all"><i class="fas fa-plus mr-2"></i> إضافة خادم</button>
                            <button id="importExcelBtn" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:shadow-lg transition-all"><i class="fas fa-file-excel mr-2"></i> استيراد Excel</button>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-x-auto">
                            <table class="w-full text-right min-w-[1200px]">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="p-4 font-bold">الصورة</th>
                                        <th class="p-4 font-bold">الاسم</th>
                                        <th id="serviceColumnHeader" class="p-4 font-bold hidden-view">الخدمة</th>
                                        <th class="p-4 font-bold">الموبايل</th>
                                        <th class="p-4 font-bold">ت. الميلاد</th>
                                        <th class="p-4 font-bold">الرقم القومي</th>
                                        <th class="p-4 font-bold">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="servantsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Page: Attendance -->
                    <div id="attendancePage" class="page-content hidden-view">
                         <h1 class="text-3xl font-bold mb-6">تسجيل حضور الأنشطة</h1>
                         <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label for="yearSelector" class="block mb-2 font-bold">اختر السنة:</label>
                                    <select id="yearSelector" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"></select>
                                </div>
                                <div>
                                    <label for="monthSelector" class="block mb-2 font-bold">اختر الشهر:</label>
                                    <select id="monthSelector" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" disabled></select>
                                </div>
                            </div>
                            <div id="fridaysGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6"></div>
                            <div id="activityButtons" class="hidden-view grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-6"></div>
                            <div id="attendanceListContainer" class="hidden-view mt-6 border-t pt-6">
                                <h3 id="attendanceListTitle" class="text-xl font-bold mb-4"></h3>
                                <div id="noActivitySection" class="mb-4 p-3 bg-yellow-100 dark:bg-yellow-800 border-r-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 rounded-md">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="noActivityCheck" class="ml-3 h-5 w-5 rounded text-cyan-600 focus:ring-cyan-500">
                                        <span id="noActivityLabel"></span>
                                    </label>
                                    <textarea id="noActivityReason" placeholder="اكتب السبب أو الملاحظة هنا..." class="w-full p-2 mt-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 hidden"></textarea>
                                </div>
                                <div id="servantsChecklist" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2"></div>
                                <button id="saveActivityAttendanceBtn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:shadow-lg transition-all"><i class="fas fa-save mr-2"></i> حفظ الحضور</button>
                            </div>
                         </div>
                    </div>

                    <!-- Page: Reports -->
                    <div id="reportsPage" class="page-content hidden-view">
                        <h1 class="text-3xl font-bold mb-6">التقارير والإحصائيات</h1>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="border-b pb-4 mb-4">
                                <div id="reportTabs" class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                                    <button data-report-type="individual" class="report-tab active flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300">تقرير فردي</button>
                                    <button data-report-type="comprehensive" class="report-tab flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300">تقرير شامل</button>
                                    <button data-report-type="averages" class="report-tab flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300">تقرير المتوسطات</button>
                                </div>
                                <div id="reportFilters" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                        <div id="serviceFilterContainer" class="hidden-view">
                                            <label for="reportServiceSelector" class="block mb-2 font-bold text-sm">اختر الخدمة:</label>
                                            <select id="reportServiceSelector" class="w-full p-3 h-14 text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"></select>
                                        </div>
                                        <div id="servantSelectorContainer" class="md:col-span-2">
                                            <label for="reportServantSelector" class="block mb-2 font-bold text-sm">اختر خادم:</label>
                                            <select id="reportServantSelector" class="w-full p-3 h-14 text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"></select>
                                        </div>
                                        <div>
                                            <label for="reportStartDate" class="block mb-2 font-bold text-sm">من تاريخ:</label>
                                            <input type="date" id="reportStartDate" class="w-full p-3 h-14 text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                        </div>
                                        <div>
                                            <label for="reportEndDate" class="block mb-2 font-bold text-sm">إلى تاريخ:</label>
                                            <input type="date" id="reportEndDate" class="w-full p-3 h-14 text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                        </div>
                                    </div>
                                    <button id="generateReportBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all">
                                        <i class="fas fa-cogs mr-2"></i> إنشاء التقرير
                                    </button>
                                </div>
                            </div>
                            <div id="reportOutput" class="hidden-view">
                                <div id="reportContent" class="my-6"></div>
                                <div id="exportButtons" class="flex justify-end gap-4 border-t pt-4">
                                    <button id="exportPngBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all"><i class="fas fa-file-image mr-2"></i> تصدير كصورة (PNG)</button>
                                    <button id="exportPdfBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all"><i class="fas fa-file-pdf mr-2"></i> تصدير كملف (PDF)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="loginModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <div class="flex justify-between items-center pb-3">
                <h3 id="modalTitle" class="text-2xl font-bold"></h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl" aria-label="إغلاق النافذة">&times;</button>
            </div>
            <form id="loginForm" class="mt-4">
                <p class="text-md mb-4">الرجاء إدخال كود الدخول المكون من 6 أرقام.</p>
                <input id="codeInput" type="number" placeholder="******" class="w-full px-4 py-3 text-lg text-center tracking-[1em] bg-gray-100 dark:bg-gray-700 border-2 rounded-lg focus:outline-none focus:border-cyan-500">
                <p id="errorMessage" class="text-red-500 text-sm mt-2 h-5"></p>
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg mt-4">دخــــول</button>
            </form>
        </div>
    </div>
    <div id="manualEntryModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-lg mx-auto rounded-xl shadow-lg z-50 p-8 max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center pb-3">
                <h3 id="manualEntryModalTitle" class="text-2xl font-bold">إضافة خادم جديد</h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl" aria-label="إغلاق النافذة">&times;</button>
            </div>
            <form id="manualEntryForm" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="servantId">
                <input type="text" id="servantName" placeholder="الاسم بالكامل" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg md:col-span-2">
                <input type="tel" id="servantMobile" placeholder="رقم الموبايل" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <input type="date" id="servantDob" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300">
                <input type="text" id="servantNationalId" placeholder="الرقم القومي" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg md:col-span-2">
                <input type="text" id="servantCurrentService" placeholder="الخدمة الحالية" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <input type="text" id="servantJob" placeholder="الوظيفة" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <textarea id="servantAddress" placeholder="العنوان" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg md:col-span-2"></textarea>
                <input type="text" id="servantQualification" placeholder="المؤهل" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <input type="text" id="servantConfessionFather" placeholder="أب الاعتراف" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <div class="md:col-span-2">
                    <label class="block mb-2 text-sm font-medium">صورة الخادم (اختياري)</label>
                    <input type="file" id="servantImageFile" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                    <img id="imagePreview" src="" alt="Image Preview" class="mt-4 rounded-lg max-h-40 hidden"/>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg md:col-span-2">حفظ البيانات</button>
            </form>
        </div>
    </div>
    <div id="importModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <div class="flex justify-between items-center pb-3">
                <h3 class="text-2xl font-bold">استيراد من Excel</h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl" aria-label="إغلاق النافذة">&times;</button>
            </div>
            <form id="importForm" class="mt-4">
                <p class="text-md mb-4">اختر ملف Excel (.xlsx, .xls). سيتم البدء من الصف الخامس.</p>
                <input type="file" id="excelFile" accept=".xlsx, .xls" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg mt-4">استيراد</button>
            </form>
        </div>
    </div>
    <div id="confirmModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <h3 id="confirmModalTitle" class="text-xl font-bold mb-4">تأكيد الإجراء</h3>
            <p id="confirmModalBody" class="mb-6">هل أنت متأكد من أنك تريد المتابعة؟</p>
            <div class="flex justify-end gap-4">
                <button id="confirmModalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
                <button id="confirmModalConfirmBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">تأكيد</button>
            </div>
        </div>
    </div>
    <div id="messageBox" class="hidden fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl z-50"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, getDoc, getDocs, updateDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==================================================================
        // FILE: config.js (Application Configuration)
        // ==================================================================
        const services = [
            { name: "خدمة B.C", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962A3 3 0 013 11.18V11a6 6 0 0112 0v.18a3 3 0 01-5.318 2.498M2 12h20M12 12v9" />', color: 'cyan' },
            { name: "خدمة KG", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-9-5.747h18" />', color: 'lime' },
            { name: "خدمة أولى ابتدائي", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-9-5.747h18" />', color: 'green' },
            { name: "خدمة ثانية ابتدائي", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.373 3.373 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />', color: 'yellow' },
            { name: "خدمة ثالثة ورابعة بنات", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6a6 6 0 016 6v1h-3" />', color: 'pink' },
            { name: "خدمة ثالثة ورابعة أولاد", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />', color: 'indigo' },
            { name: "خدمة خامسة وسادسة بنات", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />', color: 'red' },
            { name: "خدمة خامسة وسادسة أولاد", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />', color: 'purple' },
            { name: "خدمة الكورال والأنشطة", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3" />', color: 'teal' },
            { name: "خدمة وسائل الإيضاح", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />', color: 'orange' },
            { name: "الامين العام", icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v2h8z" />', color: 'blue' }
        ];
        
        const activities = [
            { key: 'visiting', name: 'الافتقاد', icon: 'fa-hand-holding-heart', color: 'rgba(249, 115, 22, 0.7)', borderColor: 'rgba(249, 115, 22, 1)' },
            { key: 'preparation', name: 'التحضير', icon: 'fa-book-open', color: 'rgba(234, 179, 8, 0.7)', borderColor: 'rgba(234, 179, 8, 1)' },
            { key: 'mass', name: 'القداس', icon: 'fa-cross', color: 'rgba(239, 68, 68, 0.7)', borderColor: 'rgba(239, 68, 68, 1)' },
            { key: 'service', name: 'الخدمة', icon: 'fa-church', color: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)' },
            { key: 'explanation', name: 'الشرح', icon: 'fa-chalkboard-teacher', color: 'rgba(34, 197, 94, 0.7)', borderColor: 'rgba(34, 197, 94, 1)' }
        ];
        
        const CORRECT_CODE = '123456';
        const ADMIN_CODE = '999999';
        const activityMap = new Map(activities.map(a => [a.key, a]));


        // ==================================================================
        // FILE: app.js (Main Application Logic)
        // ==================================================================

        // --- GLOBAL STATE ---
        let currentServiceName = '';
        let db, auth, userId, servantsUnsubscribe = null;
        let servantsCache = [];
        let attendanceYearCache = {}; 
        let currentActivity = '';
        let selectedFriday = '';
        let currentReportType = 'individual';
        let isGeneralSecretaryMode = false;
        let allServantsCache = [];
        let allAttendanceCache = [];
        let isLocalMode = false;
        // Chart instances
        let reportChart1 = null;
        let reportChart2 = null;
        let homeChart = null;
        let adminChart = null;
        // FIX: Auth Ready Promise
        let authReadyPromiseResolver;
        const authReady = new Promise(resolve => {
            authReadyPromiseResolver = resolve;
        });


        // --- DOM ELEMENTS CACHE ---
        let DOMElements = {};

        // --- LOCAL STORAGE HELPERS ---
        const getLocalData = (key) => JSON.parse(localStorage.getItem(key) || 'null');
        const setLocalData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const getLocalServants = (serviceName) => getLocalData(`church-app-servants-${serviceName}`) || [];
        const saveLocalServants = (servants, serviceName) => setLocalData(`church-app-servants-${serviceName}`, servants);
        const getLocalAttendance = (serviceName) => getLocalData(`church-app-attendance-${serviceName}`) || {};
        const saveLocalAttendance = (attendance, serviceName) => setLocalData(`church-app-attendance-${serviceName}`, attendance);

        // --- UI FUNCTIONS ---
        const showLoading = (isLoading) => {
            DOMElements.loadingOverlay.classList.toggle('flex', isLoading);
            DOMElements.loadingOverlay.classList.toggle('hidden-view', !isLoading);
        };
        const showMessage = (text, isError = false) => {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            messageBox.classList.remove('hidden-view');
            setTimeout(() => messageBox.classList.add('hidden-view'), 3000);
        };
        const openModal = (modal) => modal.classList.replace('hidden-view', 'flex');
        const closeModal = (modal) => modal.classList.replace('flex', 'hidden-view');
        
        const showConfirm = (title, body, onConfirm) => {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').innerHTML = body;
            openModal(DOMElements.confirmModal);
            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            const cancelBtn = document.getElementById('confirmModalCancelBtn');
            
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            const confirmHandler = () => { onConfirm(); closeModal(DOMElements.confirmModal); };
            const cancelHandler = () => closeModal(DOMElements.confirmModal);
            
            newConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        };
        
        // --- CORE APP LOGIC ---
        async function initializeFirebase() {
            try {
                // --- Firebase Configuration ---
                const firebaseConfig = {
                  apiKey: "AIzaSyDqnWPGTAvIWakd0Wl14uuznrCy2oo8Iws",
                  authDomain: "church-service-app-4f180.firebaseapp.com",
                  projectId: "church-service-app-4f180",
                  storageBucket: "church-service-app-4f180.appspot.com",
                  messagingSenderId: "431475695196",
                  appId: "1:431475695196:web:4bd4389448eb94804e1099"
                };
                // -----------------------------

                isLocalMode = false;
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authReadyPromiseResolver(); // Resolve the promise
                    } else {
                        try {
                           await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Sign-in failed:", error);
                            showMessage("فشل الاتصال بقاعدة البيانات", true);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("فشل تهيئة النظام. سيتم التشغيل في الوضع المحلي.", true);
                isLocalMode = true;
                userId = 'localUser';
            }
        }
        
        function populateServices() {
            DOMElements.servicesGrid.innerHTML = '';
            services.forEach(service => {
                const card = document.createElement('div');
                card.className = `service-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transform transition-all duration-300 cursor-pointer flex flex-col items-center text-center border-2 border-transparent hover:ring-4 hover:ring-offset-2 hover:ring-${service.color}-400 dark:hover:ring-offset-gray-900`;
                card.dataset.serviceName = service.name;
                card.innerHTML = `<div class="bg-${service.color}-100 dark:bg-${service.color}-900 p-4 rounded-full mb-4"><svg class="w-10 h-10 text-${service.color}-500 dark:text-${service.color}-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${service.icon}</svg></div><h3 class="text-xl font-bold">${service.name}</h3>`;
                DOMElements.servicesGrid.appendChild(card);
            });
        }

        async function showDashboard() {
            await authReady;
            DOMElements.loginOrServicesView.classList.add('hidden-view');
            DOMElements.mainDashboard.classList.remove('hidden-view');
            document.getElementById('sidebarServiceName').textContent = currentServiceName;
            
            DOMElements.sidebarLinks.querySelector('[data-page="servantsPage"]').classList.toggle('hidden-view', isGeneralSecretaryMode);
            DOMElements.sidebarLinks.querySelector('[data-page="attendancePage"]').classList.toggle('hidden-view', isGeneralSecretaryMode);
            
            showLoading(true);
            if (isGeneralSecretaryMode) {
                document.getElementById('sidebarServiceName').textContent = "عرض شامل (الامين العام)";
                await loadAllServicesData();
                switchPage('homePage'); // Start at dashboard for admin
            } else {
                await loadServants();
                switchPage('homePage');
            }
            showLoading(false);
        }

        function returnToMainMenu() {
            DOMElements.mainDashboard.classList.add('hidden-view');
            DOMElements.loginOrServicesView.classList.remove('hidden-view');
            document.getElementById('sidebarServiceName').textContent = '';
            currentServiceName = '';
            if (servantsUnsubscribe) servantsUnsubscribe();
            servantsCache = [];
            attendanceYearCache = {};
            isGeneralSecretaryMode = false;
            allServantsCache = [];
            allAttendanceCache = [];
            DOMElements.sidebarLinks.querySelector('[data-page="servantsPage"]').classList.remove('hidden-view');
            DOMElements.sidebarLinks.querySelector('[data-page="attendancePage"]').classList.remove('hidden-view');
        }
        
        async function switchPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden-view'));
            document.getElementById(pageId).classList.remove('hidden-view');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            const activeLink = DOMElements.sidebarLinks.querySelector(`.sidebar-link[data-page="${pageId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                DOMElements.mobilePageTitle.textContent = activeLink.innerText;
            }

            if (window.innerWidth < 768) {
                DOMElements.sidebar.classList.add('translate-x-full');
                DOMElements.sidebarOverlay.classList.add('hidden');
            }
            
            if (pageId === 'homePage') updateHomePageDashboard();
            if (pageId === 'servantsPage') displayUpcomingBirthdays();
            if (pageId === 'attendancePage' && !isGeneralSecretaryMode) loadAttendancePage();
            if (pageId === 'reportsPage') {
                loadReportsPage();
            }
        }

        // --- DATA FETCHING ---
        async function fetchData(collectionName, serviceName) {
            await authReady;
            if (isLocalMode) {
                return getLocalData(`church-app-${collectionName}-${serviceName}`) || (collectionName === 'attendance' ? {} : []);
            }
            try {
                const appId = "church-service-app-4f180"; // Using hardcoded App ID from config
                const colRef = collection(db, `artifacts/${appId}/users/${userId}/services/${serviceName}/${collectionName}`);
                const snapshot = await getDocs(colRef);
                if (collectionName === 'attendance') {
                    const attendanceData = {};
                    snapshot.docs.forEach(doc => {
                        attendanceData[doc.id] = doc.data();
                    });
                    return attendanceData;
                }
                return snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            } catch (error) {
                console.error(`Error fetching ${collectionName} for ${serviceName}:`, error);
                showMessage(`خطأ في تحميل بيانات ${collectionName}.`, true);
                return collectionName === 'attendance' ? {} : [];
            }
        }

        function loadServants() {
            return new Promise(async (resolve) => {
                await authReady;
                if (isLocalMode) {
                    servantsCache = getLocalServants(currentServiceName);
                    servantsCache.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                    renderServantsTable(servantsCache);
                    populateReportServantSelector();
                    return resolve();
                }
                const appId = "church-service-app-4f180"; // Using hardcoded App ID from config
                if (!userId || !currentServiceName) return resolve();
                const servantsCol = collection(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/servants`);
                if (servantsUnsubscribe) servantsUnsubscribe();
                servantsUnsubscribe = onSnapshot(servantsCol, (snapshot) => {
                    servantsCache = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    servantsCache.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                    renderServantsTable(servantsCache);
                    populateReportServantSelector();
                    updateHomePageDashboard();
                    resolve();
                }, (error) => {
                    console.error("Error loading servants:", error);
                    showMessage("خطأ في تحميل بيانات الخدام.", true);
                    resolve();
                });
            });
        }
        
        async function loadAttendanceForYear(year) {
            await authReady;
            if (isLocalMode) {
                attendanceYearCache = getLocalAttendance(currentServiceName);
                return;
            }
            try {
                const appId = "church-service-app-4f180"; // Using hardcoded App ID from config
                const attendanceCol = collection(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/attendance`);
                const q = query(attendanceCol, where('year', '==', Number(year)));
                const snapshot = await getDocs(q);
                attendanceYearCache = {};
                snapshot.docs.forEach(doc => {
                    attendanceYearCache[doc.id] = doc.data();
                });
            } catch (error) {
                console.error(`Error loading attendance for year ${year}:`, error);
                showMessage(`فشل تحميل بيانات الحضور لسنة ${year}.`, true);
                attendanceYearCache = {};
            }
        }
        
        async function loadAllServicesData() {
            await authReady;
            showLoading(true);
            const servicesToFetch = services.filter(s => s.name !== 'الامين العام');
            
            const fetchPromises = servicesToFetch.map(async (service) => {
                const serviceName = service.name;
                const [serviceServants, serviceAttendance] = await Promise.all([
                    fetchData('servants', serviceName),
                    fetchData('attendance', serviceName)
                ]);
                const attendanceArray = Object.entries(serviceAttendance).map(([date, data]) => ({ date, ...data, serviceName }));
                serviceServants.forEach(s => s.serviceName = serviceName);
                return { serviceServants, serviceAttendance: attendanceArray };
            });

            try {
                const results = await Promise.all(fetchPromises);
                allServantsCache = results.flatMap(r => r.serviceServants);
                allAttendanceCache = results.flatMap(r => r.serviceAttendance);
                allServantsCache.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } catch (error) {
                console.error("Error loading all services data:", error);
                showMessage("فشل تحميل البيانات المجمعة.", true);
            } finally {
                showLoading(false);
            }
        }

        // --- SERVANTS FUNCTIONS ---
        function renderServantsTable(servantsToRender) {
            DOMElements.serviceColumnHeader.classList.toggle('hidden-view', !isGeneralSecretaryMode);
            DOMElements.servantsTableBody.innerHTML = '';
            if (!servantsToRender || servantsToRender.length === 0) {
                 DOMElements.servantsTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">لا يوجد خدام لعرضهم.</td></tr>`;
                 return;
            }
            servantsToRender.forEach(servant => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50';
                const imageUrl = servant.imageUrl || 'https://placehold.co/60x60/E2E8F0/4A5568?text=?';
                const val = (data) => data || 'غير متوفر';
                row.innerHTML = `
                    <td class="p-4"><img src="${imageUrl}" alt="صورة ${val(servant.name)}" class="w-14 h-14 rounded-full object-cover" loading="lazy"></td>
                    <td class="p-4 font-semibold">${val(servant.name)}</td>
                    ${isGeneralSecretaryMode ? `<td class="p-4">${val(servant.serviceName)}</td>` : ''}
                    <td class="p-4">${val(servant.mobile)}</td>
                    <td class="p-4">${val(servant.dob)}</td>
                    <td class="p-4">${val(servant.nationalId)}</td>
                    <td class="p-4 space-x-2 whitespace-nowrap">
                        <button class="text-blue-500 hover:text-blue-700 edit-btn" data-id="${servant.id}" aria-label="تعديل ${val(servant.name)}"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="text-red-500 hover:text-red-700 delete-btn" data-id="${servant.id}" aria-label="حذف ${val(servant.name)}"><i class="fas fa-trash"></i> حذف</button>
                    </td>`;
                DOMElements.servantsTableBody.appendChild(row);
            });
        }
        
        function displayUpcomingBirthdays() {
            const container = document.getElementById('birthdayAlertsContainer');
            container.innerHTML = ''; 
            const sourceServants = isGeneralSecretaryMode ? allServantsCache : servantsCache;
            if (!sourceServants || sourceServants.length === 0) return;

            const upcoming = getUpcomingBirthdays(sourceServants, 5); // Get up to 5

            if (upcoming.length > 0) {
                let alertHTML = `<div class="p-4 bg-cyan-100 dark:bg-cyan-900 border-r-4 border-cyan-500 rounded-lg text-cyan-800 dark:text-cyan-200"><div class="flex items-center"><i class="fas fa-birthday-cake text-2xl ml-4"></i><div><h4 class="font-bold">أعياد ميلاد قادمة!</h4><ul class="list-disc list-inside mt-2">`;
                upcoming.forEach(person => {
                    const dayText = person.daysUntil === 0 ? 'اليوم!' : `بعد ${person.daysUntil} يوم`;
                    const serviceText = isGeneralSecretaryMode ? ` (${person.serviceName})` : '';
                    alertHTML += `<li><strong>${person.name}</strong>${serviceText} - ${person.date} (${dayText})</li>`;
                });
                alertHTML += `</ul></div></div></div>`;
                container.innerHTML = alertHTML;
            }
        }
        
        async function handleServantFormSubmit(e) {
            e.preventDefault();
            const servantId = DOMElements.manualEntryForm.querySelector('#servantId').value;
            let servantData = {
                name: DOMElements.manualEntryForm.querySelector('#servantName').value,
                mobile: DOMElements.manualEntryForm.querySelector('#servantMobile').value,
                dob: DOMElements.manualEntryForm.querySelector('#servantDob').value,
                nationalId: DOMElements.manualEntryForm.querySelector('#servantNationalId').value,
                currentService: DOMElements.manualEntryForm.querySelector('#servantCurrentService').value,
                address: DOMElements.manualEntryForm.querySelector('#servantAddress').value,
                qualification: DOMElements.manualEntryForm.querySelector('#servantQualification').value,
                job: DOMElements.manualEntryForm.querySelector('#servantJob').value,
                confessionFather: DOMElements.manualEntryForm.querySelector('#servantConfessionFather').value,
                imageUrl: DOMElements.imagePreview.src.startsWith('data:image') ? DOMElements.imagePreview.src : (servantId ? servantsCache.find(s => s.id === servantId).imageUrl : null)
            };
            
            showLoading(true);
            if (servantId) {
                await updateServant(servantId, servantData);
            } else {
                await addServant(servantData);
            }
            showLoading(false);
            closeModal(DOMElements.manualEntryModal);
        }

        async function addServant(servantData) {
            await authReady;
            if (isLocalMode) {
                const servants = getLocalServants(currentServiceName);
                servantData.id = `local-${Date.now()}`;
                servants.push(servantData);
                saveLocalServants(servants, currentServiceName);
                await loadServants();
                showMessage("تم إضافة الخادم بنجاح (محلياً)!");
                return;
            }
            try {
                const appId = "church-service-app-4f180"; // Using hardcoded App ID from config
                const servantsCol = collection(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/servants`);
                await addDoc(servantsCol, servantData);
                showMessage("تم إضافة الخادم بنجاح!");
            } catch (error) {
                console.error("Error adding servant:", error);
                showMessage("فشل إضافة الخادم. الرجاء المحاولة مرة أخرى.", true);
            }
        }
        
        async function updateServant(servantId, servantData) {
            await authReady;
            if (isLocalMode) {
                let servants = getLocalServants(currentServiceName);
                const servantIndex = servants.findIndex(s => s.id === servantId);
                if (servantIndex > -1) {
                    servants[servantIndex] = { ...servants[servantIndex], ...servantData };
                    saveLocalServants(servants, currentServiceName);
                    await loadServants();
                    showMessage("تم تحديث بيانات الخادم (محلياً)!");
                }
                return;
            }
            try {
                const appId = "church-service-app-4f180"; // Using hardcoded App ID from config
                const servantDocRef = doc(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/servants`, servantId);
                await updateDoc(servantDocRef, servantData);
                showMessage("تم تحديث بيانات الخادم بنجاح!");
            } catch (error) {
                console.error("Error updating servant:", error);
                showMessage("فشل تحديث بيانات الخادم.", true);
            }
        }

        async function deleteServant(servantId) {
            await authReady;
            showConfirm('تأكيد الحذف', 'هل أنت متأكد من حذف هذا الخادم؟ سيتم حذف جميع بياناته بشكل نهائي.', async () => {
                showLoading(true);
                if (isLocalMode) {
                    let servants = getLocalServants(currentServiceName);
                    servants = servants.filter(s => s.id !== servantId);
                    saveLocalServants(servants, currentServiceName);
                    await loadServants();
                    showLoading(false);
                    showMessage("تم حذف الخادم (محلياً).");
                    return;
                }
                try {
                    const appId = "church-service-app-4f180"; // Using hardcoded App ID from config
                    const servantDocRef = doc(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/servants`, servantId);
                    await deleteDoc(servantDocRef);
                    showMessage("تم حذف الخادم بنجاح.");
                } catch (error) {
                    console.error("Error deleting servant:", error);
                    showMessage("فشل حذف الخادم.", true);
                } finally {
                    showLoading(false);
                }
            });
        }
        
        function handleEditClick(servantId) {
            const servant = servantsCache.find(s => s.id === servantId);
            if (!servant) return;

            const form = DOMElements.manualEntryForm;
            form.reset(); 
            
            DOMElements.manualEntryModalTitle.textContent = 'تعديل بيانات خادم';
            form.querySelector('#servantId').value = servant.id || '';
            form.querySelector('#servantName').value = servant.name || '';
            form.querySelector('#servantMobile').value = servant.mobile || '';
            form.querySelector('#servantDob').value = servant.dob || '';
            form.querySelector('#servantNationalId').value = servant.nationalId || '';
            form.querySelector('#servantCurrentService').value = servant.currentService || '';
            form.querySelector('#servantAddress').value = servant.address || '';
            form.querySelector('#servantQualification').value = servant.qualification || '';
            form.querySelector('#servantJob').value = servant.job || '';
            form.querySelector('#servantConfessionFather').value = servant.confessionFather || '';

            if (servant.imageUrl) {
                DOMElements.imagePreview.src = servant.imageUrl;
                DOMElements.imagePreview.classList.remove('hidden');
            } else {
                DOMElements.imagePreview.src = '';
                DOMElements.imagePreview.classList.add('hidden');
            }

            openModal(DOMElements.manualEntryModal);
        }

        // --- ATTENDANCE FUNCTIONS ---
        function loadAttendancePage() {
            DOMElements.yearSelector.innerHTML = '<option value="">اختر سنة</option>';
            for (let i = 2030; i >= 2025; i--) {
                DOMElements.yearSelector.innerHTML += `<option value="${i}">${i}</option>`;
            }
            DOMElements.monthSelector.innerHTML = '<option value="">اختر شهر</option>';
            DOMElements.monthSelector.disabled = true;
            DOMElements.fridaysGrid.innerHTML = '';
            DOMElements.activityButtons.classList.add('hidden-view');
            DOMElements.attendanceListContainer.classList.add('hidden-view');
        }

        function populateMonths(year) {
            DOMElements.monthSelector.innerHTML = '<option value="">اختر شهر</option>';
            const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            months.forEach((month, index) => {
                DOMElements.monthSelector.innerHTML += `<option value="${index}">${month}</option>`;
            });
            DOMElements.monthSelector.disabled = false;
        }

        function populateFridaysGrid(year, month) {
            DOMElements.fridaysGrid.innerHTML = '';
            const fridays = [];
            const date = new Date(year, month, 1);
            while (date.getMonth() === month) {
                if (date.getDay() === 5) { // 5 is for Friday
                    fridays.push(new Date(date.getTime()));
                }
                date.setDate(date.getDate() + 1);
            }
            
            for (const friday of fridays) {
                const y = friday.getFullYear();
                const m = (friday.getMonth() + 1).toString().padStart(2, '0');
                const d = friday.getDate().toString().padStart(2, '0');
                const dateString = `${y}-${m}-${d}`;
                
                const day = friday.getDate();
                let buttonHTML = `<button data-date="${dateString}" class="friday-btn h-20 flex flex-col items-center justify-between p-2 rounded-lg bg-cyan-500 text-white font-bold transition-all duration-200 shadow hover:shadow-lg hover:bg-cyan-600">
                    <span class="flex-grow flex items-center text-2xl font-bold">${day}</span>`;
                
                const dayData = attendanceYearCache[dateString] || {};
                
                let dotsHTML = '<div class="flex justify-center items-center gap-1.5">';
                activities.forEach(act => {
                    const activityData = dayData[act.key];
                    const color = activityData && activityData.attendees && activityData.attendees.length > 0 ? act.borderColor : (activityData && activityData.note ? '#facc15' : (activityData ? '#f87171' : '#d1d5db'));
                    dotsHTML += `<span style="background-color: ${color};" class="block w-3.5 h-3.5 rounded-full border-2 border-white/70 shadow-sm"></span>`;
                });
                dotsHTML += '</div>';

                buttonHTML += dotsHTML;
                buttonHTML += `</button>`;
                DOMElements.fridaysGrid.insertAdjacentHTML('beforeend', buttonHTML);
            }
        }
        
        async function updateActivityButtonsStatus(date) {
            const dayData = attendanceYearCache[date] || {};

            DOMElements.activityButtons.innerHTML = '';
            activities.forEach(act => {
                const activityData = dayData[act.key];
                let statusIcon = '', statusText = '';
                if (activityData) {
                    if (activityData.note !== null && activityData.note !== undefined) {
                        statusIcon = `<i class="fas fa-exclamation-circle text-yellow-300 ml-2"></i>`;
                        statusText = `<span class="text-xs font-normal">ملغى</span>`;
                    } else if (activityData.attendees) {
                        statusIcon = `<i class="fas fa-check-circle text-green-300 ml-2"></i>`;
                        statusText = `<span class="text-xs font-normal">${activityData.attendees.length}/${servantsCache.length} حاضر</span>`;
                    }
                }
                DOMElements.activityButtons.innerHTML += `<button data-activity="${act.key}" class="activity-btn p-3 rounded-lg text-white font-bold transition-all duration-200 shadow hover:shadow-lg flex flex-col items-center justify-center" style="background-color: ${act.borderColor}"><div class="flex items-center"><i class="fas ${act.icon} mr-2"></i><span>${act.name}</span></div><div class="mt-1 h-4">${statusIcon}${statusText}</div></button>`;
            });
            DOMElements.activityButtons.classList.remove('hidden-view');
        }

        async function showActivityChecklist(activityKey, date) {
            currentActivity = activityKey;
            const activity = activityMap.get(activityKey);
            document.querySelectorAll('.activity-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.activity-btn[data-activity="${activityKey}"]`).classList.add('active');
            
            const [year, month, day] = date.split('-').map(Number);
            const displayDate = new Date(year, month - 1, day);
            const formattedDate = displayDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            DOMElements.attendanceListTitle.textContent = `تسجيل حضور: ${activity.name} - ${formattedDate}`;
            DOMElements.servantsChecklist.innerHTML = '';
            
            DOMElements.noActivityCheck.checked = false;
            DOMElements.noActivityReason.value = '';
            DOMElements.noActivityReason.classList.add('hidden');
            DOMElements.noActivityLabel.textContent = `لا يوجد ${activity.name} لهذا اليوم`;
            DOMElements.servantsChecklist.classList.remove('hidden');

            const dayData = attendanceYearCache[date] || {};
            const activityData = dayData[activityKey] || {};
            
            const attendees = activityData.attendees || [];
            if (activityData.note !== undefined && activityData.note !== null) {
                DOMElements.noActivityCheck.checked = true;
                DOMElements.noActivityReason.value = activityData.note;
                DOMElements.noActivityReason.classList.remove('hidden');
                DOMElements.servantsChecklist.classList.add('hidden');
            }

            servantsCache.forEach(servant => {
                const isChecked = attendees.includes(servant.id);
                const a_id = `${activityKey}-${servant.id}`;
                DOMElements.servantsChecklist.innerHTML += `<div class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><input id="${a_id}" type="checkbox" data-servant-id="${servant.id}" class="w-5 h-5 ml-3 rounded text-cyan-600 focus:ring-cyan-500" ${isChecked ? 'checked' : ''}><label for="${a_id}" class="cursor-pointer">${servant.name}</label></div>`;
            });
            DOMElements.attendanceListContainer.classList.remove('hidden-view');
        }
        
        async function saveActivityAttendance() {
            await authReady;
            if (!selectedFriday || !currentActivity) return showMessage("الرجاء اختيار اليوم والنشاط أولاً.", true);
            
            const [year, month, day] = selectedFriday.split('-').map(Number);
            
            const activityUpdate = { year: Number(year) };
            if (DOMElements.noActivityCheck.checked) {
                activityUpdate.attendees = [];
                activityUpdate.note = DOMElements.noActivityReason.value || 'تم الإلغاء';
            } else {
                const attendees = Array.from(DOMElements.servantsChecklist.querySelectorAll('input[type="checkbox"]:checked'))
                                       .map(checkbox => checkbox.dataset.servantId);
                activityUpdate.attendees = attendees;
                activityUpdate.note = null;
            }

            const dayData = attendanceYearCache[selectedFriday] || { year: Number(year) };
            dayData[currentActivity] = activityUpdate;
            
            if (isLocalMode) {
                attendanceYearCache[selectedFriday] = dayData;
                saveLocalAttendance(attendanceYearCache, currentServiceName);
            } else {
                try {
                    const appId = "church-service-app-4f180"; // Using hardcoded App ID from config
                    const dayDocRef = doc(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/attendance`, selectedFriday);
                    await setDoc(dayDocRef, dayData); 
                    attendanceYearCache[selectedFriday] = dayData;
                } catch (error) {
                    console.error("Error saving attendance:", error);
                    showMessage("فشل حفظ الحضور.", true);
                    return;
                }
            }
            
            showMessage(`تم حفظ الحضور بنجاح.`);
            DOMElements.attendanceListContainer.classList.add('hidden-view');
            await updateActivityButtonsStatus(selectedFriday);
            
            const currentYear = parseInt(DOMElements.yearSelector.value);
            const currentMonth = parseInt(DOMElements.monthSelector.value);
            if (!isNaN(currentYear) && !isNaN(currentMonth)) {
                populateFridaysGrid(currentYear, currentMonth);
            }
        }

        // --- REPORTS FUNCTIONS ---
        function getPercentageColor(percentage) {
            if (percentage >= 75) return 'bg-green-500';
            if (percentage >= 50) return 'bg-yellow-500';
            return 'bg-red-500';
        }

        function getPercentageTextColor(percentage) {
            if (percentage >= 75) return 'text-green-600 dark:text-green-400';
            if (percentage >= 50) return 'text-yellow-600 dark:text-yellow-400';
            if (percentage > 0) return 'text-red-600 dark:text-red-400';
            return 'text-gray-500';
        }
        
        function getPercentageBGColor(percentage) {
            if (percentage >= 75) return 'bg-green-100 dark:bg-green-900';
            if (percentage >= 50) return 'bg-yellow-100 dark:bg-yellow-900';
            return 'bg-red-100 dark:bg-red-900';
        }

        async function loadReportsPage() {
            await authReady;
            DOMElements.reportOutput.classList.add('hidden-view');
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            DOMElements.reportStartDate.value = firstDayOfMonth.toISOString().split('T')[0];
            DOMElements.reportEndDate.value = today.toISOString().split('T')[0];
            
            document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-report-type="individual"]').classList.add('active');
            currentReportType = 'individual';
            DOMElements.servantSelectorContainer.classList.remove('hidden-view');
            
            DOMElements.serviceFilterContainer.classList.toggle('hidden-view', !isGeneralSecretaryMode);
            if (isGeneralSecretaryMode) {
                populateServiceFilter();
                 if(allServantsCache.length === 0) await loadAllServicesData();
            } else {
                const attendanceData = await fetchData('attendance', currentServiceName);
                allAttendanceCache = Object.entries(attendanceData).map(([date, data]) => ({ date, ...data }));
            }
            populateReportServantSelector();
        }
        
        function populateServiceFilter() {
            DOMElements.reportServiceSelector.innerHTML = '<option value="all">كل الخدمات</option>';
            const serviceNames = services.filter(s => s.name !== 'الامين العام').map(s => s.name);
            serviceNames.sort((a,b) => a.localeCompare(b,'ar')).forEach(name => {
                DOMElements.reportServiceSelector.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }
        
        function populateReportServantSelector(filteredServants) {
            const sourceServants = filteredServants || (isGeneralSecretaryMode ? allServantsCache : servantsCache);
            DOMElements.reportServantSelector.innerHTML = '<option value="">-- اختر --</option>';
            DOMElements.reportServantSelector.innerHTML += '<option value="all">-- كل الخدام --</option>';
            sourceServants.forEach(servant => {
                const displayName = isGeneralSecretaryMode && servant.serviceName ? `${servant.name} (${servant.serviceName})` : servant.name;
                DOMElements.reportServantSelector.innerHTML += `<option value="${servant.id}">${displayName}</option>`;
            });
        }

        function triggerReportGeneration() {
            const startDate = DOMElements.reportStartDate.value;
            const endDate = DOMElements.reportEndDate.value;
            if (!startDate || !endDate || startDate > endDate) {
                showMessage("الرجاء تحديد فترة زمنية صحيحة.", true);
                return;
            }

            let sourceAttendance = isGeneralSecretaryMode ? allAttendanceCache : allAttendanceCache;
            let sourceServants = isGeneralSecretaryMode ? allServantsCache : servantsCache;

            if (isGeneralSecretaryMode) {
                const selectedService = DOMElements.reportServiceSelector.value;
                if (selectedService !== 'all') {
                    sourceAttendance = allAttendanceCache.filter(item => item.serviceName === selectedService);
                    sourceServants = allServantsCache.filter(servant => servant.serviceName === selectedService);
                }
            }

            const filteredAttendance = sourceAttendance.filter(item => item.date >= startDate && item.date <= endDate);

            if (currentReportType === 'individual') {
                const servantId = DOMElements.reportServantSelector.value;
                if (!servantId) return showMessage("الرجاء اختيار خادم لعرض التقرير.", true);
                if (servantId === 'all') displayAllServantsAverageReport(filteredAttendance, sourceServants);
                else displayIndividualReport(servantId, filteredAttendance, sourceServants);
            } else if (currentReportType === 'comprehensive') {
                generateComprehensiveReport(filteredAttendance, sourceServants);
            } else if (currentReportType === 'averages') {
                generateAveragesReport(filteredAttendance, sourceServants);
            }
        }
        
        function displayIndividualReport(servantId, data, servants) {
            const servant = servants.find(s => s.id === servantId);
            if (!servant) return;

            DOMElements.reportContent.innerHTML = ''; 
            const reportData = { total: {}, attended: {} };
            activities.forEach(act => { reportData.total[act.key] = 0; reportData.attended[act.key] = 0; });

            data.forEach(day => {
                activities.forEach(activity => {
                    const activityData = day[activity.key];
                    if (activityData && (activityData.note === null || activityData.note === undefined)) {
                        reportData.total[activity.key]++;
                        if (activityData.attendees && activityData.attendees.includes(servantId)) {
                            reportData.attended[activity.key]++;
                        }
                    }
                });
            });

            let reportHTML = `<h3 class="text-xl font-bold mb-4">تقرير الحضور لـ: ${servant.name}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4">`;
            let percentages = [];
            activities.forEach(activity => {
                const total = reportData.total[activity.key];
                const attended = reportData.attended[activity.key];
                const percentage = total > 0 ? Math.round((attended / total) * 100) : 0;
                percentages.push(percentage);
                reportHTML += `<div class="text-center p-4 rounded-lg ${getPercentageBGColor(percentage)}"><div class="font-bold text-lg">${activity.name}</div><div class="text-3xl font-bold my-2">${percentage}%</div><div class="text-sm text-gray-500 dark:text-gray-400">(${attended} من ${total})</div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2"><div class="${getPercentageColor(percentage)} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
            });

            const overallAverage = percentages.length > 0 ? Math.round(percentages.reduce((a, b) => a + b, 0) / percentages.length) : 0;
            reportHTML += `<div class="text-center p-4 rounded-lg ${getPercentageBGColor(overallAverage)} col-span-2 md:col-span-1"><div class="font-bold text-lg">المتوسط العام</div><div class="text-3xl font-bold my-2">${overallAverage}%</div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2"><div class="${getPercentageColor(overallAverage)} h-2.5 rounded-full" style="width: ${overallAverage}%"></div></div></div>`;
            reportHTML += '</div>';
            DOMElements.reportContent.innerHTML = reportHTML;
            DOMElements.reportOutput.classList.remove('hidden-view');
        }

        function generateComprehensiveReport(data, servants) {
            DOMElements.reportContent.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'w-full text-right min-w-[1000px]';
            let tableHTML = `<thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="p-3 font-bold">اسم الخادم</th>`;
            activities.forEach(act => { tableHTML += `<th class="p-3 font-bold text-center">${act.name}</th>`; });
            tableHTML += `<th class="p-3 font-bold text-center">المتوسط العام</th></tr></thead><tbody>`;

            servants.forEach(servant => {
                tableHTML += `<tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50"><td class="p-3 font-semibold">${servant.name}</td>`;
                let percentages = [];
                activities.forEach(act => {
                    let attended = 0, meetings = 0;
                    data.forEach(day => {
                        if (day[act.key] && (day[act.key].note === null || day[act.key].note === undefined)) {
                            meetings++;
                            if (day[act.key].attendees.includes(servant.id)) attended++;
                        }
                    });
                    const percentage = meetings > 0 ? Math.round((attended / meetings) * 100) : 0;
                    percentages.push(percentage);
                    tableHTML += `<td class="p-3 text-center font-bold ${getPercentageTextColor(percentage)}">${percentage}% <span class="text-xs text-gray-500">(${attended}/${meetings})</span></td>`;
                });
                const overallPercentage = percentages.length > 0 ? Math.round(percentages.reduce((a,b) => a + b, 0) / percentages.length) : 0;
                tableHTML += `<td class="p-3 text-center font-extrabold text-cyan-600 dark:text-cyan-400">${overallPercentage}%</td></tr>`;
            });
            tableHTML += `</tbody>`;
            table.innerHTML = tableHTML;
            DOMElements.reportContent.appendChild(table);
            DOMElements.reportOutput.classList.remove('hidden-view');
        }
        
        function displayAllServantsAverageReport(data, servants) { 
            DOMElements.reportContent.innerHTML = '';
            let reportHTML = `<h3 class="text-xl font-bold mb-4">متوسط الحضور لكل الأنشطة</h3>`;
            reportHTML += '<div class="grid grid-cols-2 md:grid-cols-3 gap-4">';
            
            const activityTotals = {}, activityCounts = {};
            activities.forEach(act => { activityTotals[act.key] = 0; activityCounts[act.key] = 0; });

            data.forEach(day => {
                activities.forEach(activity => {
                    const activityData = day[activity.key];
                    if (activityData && (activityData.note === null || activityData.note === undefined)) {
                        activityTotals[activity.key] += activityData.attendees.length;
                        activityCounts[activity.key]++;
                    }
                });
            });

            const avgAttendancePercentages = activities.map(activity => {
                const totalAttendees = activityTotals[activity.key];
                const totalMeetings = activityCounts[activity.key];
                if (totalMeetings === 0 || servants.length === 0) return 0;
                return Math.round(((totalAttendees / totalMeetings) / servants.length) * 100);
            });
            
            let overallPercentages = [];
            activities.forEach((activity, index) => {
                const percentage = avgAttendancePercentages[index];
                overallPercentages.push(percentage);
                reportHTML += `<div class="text-center p-4 rounded-lg ${getPercentageBGColor(percentage)}"><div class="font-bold text-lg">${activity.name}</div><div class="text-3xl font-bold my-2">${percentage}%</div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2"><div class="${getPercentageColor(percentage)} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
            });

            const overallAverage = overallPercentages.length > 0 ? Math.round(overallPercentages.reduce((a, b) => a + b, 0) / overallPercentages.length) : 0;
            reportHTML += `<div class="text-center p-4 rounded-lg ${getPercentageBGColor(overallAverage)} col-span-2 md:col-span-1"><div class="font-bold text-lg">المتوسط العام</div><div class="text-3xl font-bold my-2">${overallAverage}%</div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2"><div class="${getPercentageColor(overallAverage)} h-2.5 rounded-full" style="width: ${overallAverage}%"></div></div></div>`;
            reportHTML += '</div>';
            DOMElements.reportContent.innerHTML = reportHTML;
            DOMElements.reportOutput.classList.remove('hidden-view');
        };
        
        function generateAveragesReport(data, servants) { 
            DOMElements.reportContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg shadow">
                        <h4 class="font-bold mb-2 text-center">متوسط نسبة الحضور لكل نشاط</h4>
                        <div class="relative h-80"><canvas id="reportAverageChartBar"></canvas></div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div id="topActivityCard" class="text-center p-4 rounded-lg bg-green-100 dark:bg-green-900"></div>
                        <div id="bottomActivityCard" class="text-center p-4 rounded-lg bg-red-100 dark:bg-red-900"></div>
                        <div class="col-span-2 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg shadow">
                             <h4 class="font-bold mb-2 text-center">توزيع الحضور</h4>
                            <div class="relative h-48"><canvas id="reportAverageChartDoughnut"></canvas></div>
                        </div>
                    </div>
                </div>
            `;

            const activityTotals = {};
            const activityCounts = {};
            activities.forEach(act => { 
                activityTotals[act.key] = 0; 
                activityCounts[act.key] = 0; 
            });

            data.forEach(day => {
                activities.forEach(activity => {
                    const activityData = day[activity.key];
                    if (activityData && (activityData.note === null || activityData.note === undefined)) {
                        activityTotals[activity.key] += activityData.attendees.length;
                        activityCounts[activity.key]++;
                    }
                });
            });

            const avgAttendance = activities.map(activity => {
                const totalAttendees = activityTotals[activity.key];
                const totalMeetings = activityCounts[activity.key];
                if (totalMeetings === 0 || servants.length === 0) return 0;
                return Math.round(((totalAttendees / totalMeetings) / servants.length) * 100);
            });

            if (reportChart1) reportChart1.destroy();
            if (reportChart2) reportChart2.destroy();

            const ctxBar = document.getElementById('reportAverageChartBar').getContext('2d');
            reportChart1 = new Chart(ctxBar, { 
                type: 'bar', 
                data: { 
                    labels: activities.map(a => a.name), 
                    datasets: [{ 
                        label: 'متوسط نسبة الحضور', 
                        data: avgAttendance, 
                        backgroundColor: activities.map(a => a.color),
                        borderColor: activities.map(a => a.borderColor),
                        borderWidth: 1 
                    }] 
                }, 
                options: { 
                    scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } }, 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                } 
            });
            
            const totalAttendanceSum = Object.values(activityTotals).reduce((a, b) => a + b, 0);
            const doughnutData = totalAttendanceSum > 0 ? activities.map(a => activityTotals[a.key]) : activities.map(() => 1);
            const ctxDoughnut = document.getElementById('reportAverageChartDoughnut').getContext('2d');
            reportChart2 = new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: {
                    labels: activities.map(a => a.name),
                    datasets: [{
                        label: 'توزيع الحضور',
                        data: doughnutData,
                        backgroundColor: activities.map(a => a.color),
                        borderColor: '#ffffff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { padding: 10 } } }
                }
            });

            const activityWithPercentages = activities.map((act, i) => ({ name: act.name, percentage: avgAttendance[i] }));
            activityWithPercentages.sort((a,b) => b.percentage - a.percentage);
            const topActivity = activityWithPercentages[0];
            const bottomActivity = activityWithPercentages[activityWithPercentages.length - 1];
            
            document.getElementById('topActivityCard').innerHTML = `<div class="font-bold text-green-800 dark:text-green-200">الأعلى حضوراً</div><div class="text-3xl font-bold my-1 text-green-600">${topActivity.percentage}%</div><div class="text-sm text-gray-500">${topActivity.name}</div>`;
            document.getElementById('bottomActivityCard').innerHTML = `<div class="font-bold text-red-800 dark:text-red-200">الأقل حضوراً</div><div class="text-3xl font-bold my-1 text-red-600">${bottomActivity.percentage}%</div><div class="text-sm text-gray-500">${bottomActivity.name}</div>`;

            DOMElements.reportOutput.classList.remove('hidden-view');
        };

        // --- Backup and Restore Functions ---
        async function backupData() {
            await authReady;
            showLoading(true);
            try {
                const servants = isLocalMode ? getLocalServants(currentServiceName) : await fetchData('servants', currentServiceName);
                const attendance = isLocalMode ? getLocalAttendance(currentServiceName) : await fetchData('attendance', currentServiceName);
                
                const backupObject = {
                    serviceName: currentServiceName,
                    exportDate: new Date().toISOString(),
                    data: {
                        servants: servants,
                        attendance: attendance
                    }
                };

                const jsonString = JSON.stringify(backupObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${currentServiceName.replace(/\s/g, '_')}-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage("تم إنشاء ملف النسخة الاحتياطية بنجاح.");
            } catch (error) {
                console.error("Backup failed:", error);
                showMessage("فشل إنشاء النسخة الاحتياطية.", true);
            } finally {
                showLoading(false);
            }
        }

        function restoreData() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const backupObject = JSON.parse(event.target.result);
                        if (!backupObject.serviceName || !backupObject.data || !backupObject.data.servants || !backupObject.data.attendance) {
                            throw new Error("ملف غير صالح.");
                        }

                        if (backupObject.serviceName !== currentServiceName) {
                           return showMessage(`هذا الملف خاص بخدمة "${backupObject.serviceName}" وليس الخدمة الحالية.`, true);
                        }

                        const confirmationMessage = `
                            أنت على وشك استعادة البيانات لخدمة <strong>"${backupObject.serviceName}"</strong>.
                            <br><strong>تحذير:</strong> هذا الإجراء سيقوم بمسح جميع البيانات الحالية واستبدالها بالبيانات من الملف. هل أنت متأكد؟
                        `;

                        showConfirm("تأكيد الاستعادة", confirmationMessage, async () => {
                            await authReady;
                            showLoading(true);
                            const { servants, attendance } = backupObject.data;
                            if (isLocalMode) {
                                saveLocalServants(servants, currentServiceName);
                                saveLocalAttendance(attendance, currentServiceName);
                                await loadServants();
                                await loadAttendanceForYear(new Date().getFullYear());
                                showMessage("تم استعادة البيانات بنجاح!");
                            } else {
                                const appId = "church-service-app-4f180"; // Using hardcoded App ID from config
                                const servantsColRef = collection(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/servants`);
                                const attendanceColRef = collection(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/attendance`);

                                const deleteBatch = writeBatch(db);
                                const existingServants = await getDocs(servantsColRef);
                                existingServants.forEach(doc => deleteBatch.delete(doc.ref));
                                const existingAttendance = await getDocs(attendanceColRef);
                                existingAttendance.forEach(doc => deleteBatch.delete(doc.ref));
                                await deleteBatch.commit();

                                const idMap = {};
                                const addServantsBatch = writeBatch(db);
                                for (const servant of servants) {
                                    const oldId = servant.id;
                                    const { id, ...servantData } = servant;
                                    const newDocRef = doc(servantsColRef);
                                    idMap[oldId] = newDocRef.id;
                                    addServantsBatch.set(newDocRef, servantData);
                                }
                                await addServantsBatch.commit();

                                const addAttendanceBatch = writeBatch(db);
                                for (const [date, attendanceData] of Object.entries(attendance)) {
                                    const correctedData = { ...attendanceData };
                                    for (const activityKey in correctedData) {
                                        if (correctedData[activityKey] && Array.isArray(correctedData[activityKey].attendees)) {
                                            correctedData[activityKey].attendees = correctedData[activityKey].attendees
                                                .map(oldId => idMap[oldId])
                                                .filter(newId => newId); // Filter out any undefined IDs
                                        }
                                    }
                                    const newDocRef = doc(attendanceColRef, date);
                                    addAttendanceBatch.set(newDocRef, correctedData);
                                }
                                await addAttendanceBatch.commit();

                                showMessage("تم استعادة البيانات بنجاح!");
                            }
                            showLoading(false);
                        });

                    } catch (error) {
                        console.error("Restore failed:", error);
                        showMessage("فشل استعادة البيانات. تأكد من أن الملف صحيح.", true);
                        showLoading(false);
                    }
                };
                reader.readAsText(file);
            };
            fileInput.click();
        }


        function exportAsImage() {
            html2canvas(DOMElements.reportContent, { backgroundColor: document.body.classList.contains('dark') ? '#1f2937' : '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.download = `report-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function exportAsPdf() {
            const { jsPDF } = window.jspdf;
            html2canvas(DOMElements.reportContent, { backgroundColor: document.body.classList.contains('dark') ? '#1f2937' : '#ffffff' }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`report-${new Date().toISOString().slice(0,10)}.pdf`);
            });
        }
        
        // --- HOME PAGE DASHBOARD ---
        function getUpcomingBirthdays(sourceServants, limit = 1) {
            const upcoming = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(today.getDate() + 30);

            if (!sourceServants || sourceServants.length === 0) return [];

            sourceServants.forEach(servant => {
                if (!servant.dob) return;
                const dobParts = servant.dob.split('-');
                if (dobParts.length < 3) return;
                const birthDate = new Date(parseInt(dobParts[0]), parseInt(dobParts[1]) - 1, parseInt(dobParts[2]));
                if (isNaN(birthDate.getTime())) return;
                
                let nextBirthday = new Date(currentYear, birthDate.getMonth(), birthDate.getDate());
                if (nextBirthday < today) {
                    nextBirthday.setFullYear(currentYear + 1);
                }

                const diffTime = nextBirthday - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Condition: within next 30 days OR in the current month
                if ((nextBirthday >= today && nextBirthday <= thirtyDaysFromNow) || (nextBirthday.getMonth() === currentMonth && nextBirthday.getFullYear() === currentYear)) {
                    if (!upcoming.some(b => b.name === servant.name)) { // Avoid duplicates
                         upcoming.push({
                            name: servant.name,
                            serviceName: servant.serviceName,
                            date: nextBirthday.toLocaleDateString('ar-EG', { month: 'long', day: 'numeric' }),
                            daysUntil: diffDays
                        });
                    }
                }
            });
            
            return upcoming.sort((a, b) => a.daysUntil - b.daysUntil).slice(0, limit);
        }

        async function updateHomePageDashboard() {
            await authReady;
            DOMElements.serviceDashboardContainer.classList.toggle('hidden-view', isGeneralSecretaryMode);
            DOMElements.adminDashboardContainer.classList.toggle('hidden-view', !isGeneralSecretaryMode);

            if (isGeneralSecretaryMode) {
                // Admin Dashboard Logic
                DOMElements.adminTotalServantsStat.textContent = allServantsCache.length;
                renderAdminServantsTable(allServantsCache);

                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const startDate = thirtyDaysAgo.toISOString().split('T')[0];
                const endDate = new Date().toISOString().split('T')[0];

                const filteredAttendance = allAttendanceCache.filter(item => item.date >= startDate && item.date <= endDate);
                
                const activityTotals = {};
                const activityCounts = {};
                activities.forEach(act => { activityTotals[act.key] = 0; activityCounts[act.key] = 0; });

                filteredAttendance.forEach(day => {
                    activities.forEach(activity => {
                        const activityData = day[activity.key];
                        if (activityData && (activityData.note === null || activityData.note === undefined)) {
                            const serviceServantCount = allServantsCache.filter(s => s.serviceName === day.serviceName).length;
                            if(serviceServantCount > 0) {
                                activityTotals[activity.key] += (activityData.attendees.length / serviceServantCount);
                                activityCounts[activity.key]++;
                            }
                        }
                    });
                });

                const avgAttendance = activities.map(activity => {
                    const totalPercentageSum = activityTotals[activity.key];
                    const totalMeetings = activityCounts[activity.key];
                    if (totalMeetings === 0) return 0;
                    return Math.round((totalPercentageSum / totalMeetings) * 100);
                });

                if (adminChart) adminChart.destroy();
                const ctx = document.getElementById('adminAttendanceChart').getContext('2d');
                adminChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: activities.map(a => a.name),
                        datasets: [{
                            label: 'متوسط الحضور',
                            data: avgAttendance,
                            backgroundColor: activities.map(a => a.color),
                            borderColor: activities.map(a => a.borderColor),
                            borderWidth: 1,
                            borderRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } },
                        plugins: { legend: { display: false } }
                    }
                });

            } else {
                // Regular Service Dashboard Logic
                DOMElements.totalServantsStat.textContent = servantsCache.length;
                const nextBirthday = getUpcomingBirthdays(servantsCache, 1);
                if(nextBirthday.length > 0) {
                    DOMElements.upcomingBirthdayStat.textContent = `${nextBirthday[0].name} (${nextBirthday[0].date})`;
                } else {
                    DOMElements.upcomingBirthdayStat.textContent = 'لا يوجد';
                }

                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const startDate = thirtyDaysAgo.toISOString().split('T')[0];
                const endDate = new Date().toISOString().split('T')[0];
                
                let attendanceData = isLocalMode ? Object.values(getLocalAttendance(currentServiceName) || {}) : allAttendanceCache;
                if (!attendanceData || attendanceData.length === 0) {
                     attendanceData = Object.entries(await fetchData('attendance', currentServiceName)).map(([date, data]) => ({ date, ...data }));
                }

                const filteredAttendance = attendanceData.filter(item => item.date >= startDate && item.date <= endDate);
                
                const activityTotals = {};
                const activityCounts = {};
                activities.forEach(act => { 
                    activityTotals[act.key] = 0; 
                    activityCounts[act.key] = 0; 
                });

                filteredAttendance.forEach(day => {
                    activities.forEach(activity => {
                        const activityData = day[activity.key];
                        if (activityData && (activityData.note === null || activityData.note === undefined)) {
                            activityTotals[activity.key] += activityData.attendees.length;
                            activityCounts[activity.key]++;
                        }
                    });
                });

                const avgAttendance = activities.map(activity => {
                    const totalAttendees = activityTotals[activity.key];
                    const totalMeetings = activityCounts[activity.key];
                    if (totalMeetings === 0 || servantsCache.length === 0) return 0;
                    return Math.round(((totalAttendees / totalMeetings) / servantsCache.length) * 100);
                });

                if (homeChart) homeChart.destroy();
                const ctx = document.getElementById('homeAttendanceChart').getContext('2d');
                homeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: activities.map(a => a.name),
                        datasets: [{
                            label: 'متوسط الحضور',
                            data: avgAttendance,
                            backgroundColor: activities.map(a => a.color),
                            borderColor: activities.map(a => a.borderColor),
                            borderWidth: 1,
                            borderRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        function renderAdminServantsTable(servantsToRender) {
            DOMElements.adminServantsTableBody.innerHTML = '';
            if (!servantsToRender || servantsToRender.length === 0) {
                 DOMElements.adminServantsTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-gray-500">لا يوجد خدام لعرضهم.</td></tr>`;
                 return;
            }
            servantsToRender.forEach(servant => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-gray-700';
                const val = (data) => data || 'غير متوفر';
                row.innerHTML = `
                    <td class="p-3 font-semibold">${val(servant.name)}</td>
                    <td class="p-3">${val(servant.serviceName)}</td>
                    <td class="p-3">${val(servant.mobile)}</td>`;
                DOMElements.adminServantsTableBody.appendChild(row);
            });
        }


        // --- EVENT LISTENERS INITIALIZATION ---
        function initializeEventListeners() {
            // Main navigation
            DOMElements.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                DOMElements.errorMessage.textContent = '';
                const isAdminLogin = currentServiceName === 'الامين العام';
                isGeneralSecretaryMode = false;
                if (isAdminLogin && DOMElements.codeInput.value === ADMIN_CODE) {
                    isGeneralSecretaryMode = true;
                    closeModal(DOMElements.loginModal);
                    DOMElements.codeInput.value = '';
                    await showDashboard();
                } else if (!isAdminLogin && DOMElements.codeInput.value === CORRECT_CODE) {
                    closeModal(DOMElements.loginModal);
                    DOMElements.codeInput.value = '';
                    await showDashboard();
                } else {
                    DOMElements.errorMessage.textContent = 'الكود غير صحيح. حاول مرة أخرى.';
                }
            });

            DOMElements.sidebar.addEventListener('click', (e) => {
                const link = e.target.closest('.sidebar-link');
                if (link) { e.preventDefault(); switchPage(link.dataset.page); }
            });
            
            DOMElements.logoutBtn.addEventListener('click', returnToMainMenu);
            DOMElements.backToServicesBtn.addEventListener('click', returnToMainMenu);
            
            DOMElements.servicesGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.service-card');
                if (card) {
                    currentServiceName = card.dataset.serviceName;
                    document.getElementById('modalTitle').textContent = `الدخول إلى ${currentServiceName}`;
                    openModal(DOMElements.loginModal);
                    setTimeout(() => DOMElements.codeInput.focus(), 100);
                }
            });
            
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop')));
            });

            // Home Page Listeners
            DOMElements.backupBtn.addEventListener('click', backupData);
            DOMElements.restoreBtn.addEventListener('click', restoreData);
            DOMElements.quickAddServant.addEventListener('click', () => {
                 DOMElements.manualEntryForm.reset();
                DOMElements.manualEntryForm.querySelector('#servantId').value = '';
                DOMElements.manualEntryModalTitle.textContent = 'إضافة خادم جديد';
                DOMElements.imagePreview.classList.add('hidden');
                DOMElements.imagePreview.src = '';
                openModal(DOMElements.manualEntryModal);
            });
            DOMElements.quickGoToAttendance.addEventListener('click', () => switchPage('attendancePage'));
            DOMElements.adminSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const filteredServants = allServantsCache.filter(servant => 
                    (servant.name && servant.name.toLowerCase().includes(searchTerm)) ||
                    (servant.mobile && String(servant.mobile).includes(searchTerm))
                );
                renderAdminServantsTable(filteredServants);
            });


            // Servants Page Listeners
            DOMElements.searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const filteredServants = servantsCache.filter(servant => 
                    (servant.name && servant.name.toLowerCase().includes(searchTerm)) ||
                    (servant.mobile && String(servant.mobile).includes(searchTerm))
                );
                renderServantsTable(filteredServants);
            });
            DOMElements.servantsActions.querySelector('#addManualBtn').addEventListener('click', () => {
                DOMElements.manualEntryForm.reset();
                DOMElements.manualEntryForm.querySelector('#servantId').value = '';
                DOMElements.manualEntryModalTitle.textContent = 'إضافة خادم جديد';
                DOMElements.imagePreview.classList.add('hidden');
                DOMElements.imagePreview.src = '';
                openModal(DOMElements.manualEntryModal);
            });
            DOMElements.servantsActions.querySelector('#importExcelBtn').addEventListener('click', () => openModal(DOMElements.importModal));
            DOMElements.manualEntryForm.addEventListener('submit', handleServantFormSubmit);
            DOMElements.importForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const file = DOMElements.importForm.querySelector('#excelFile').files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        showLoading(true);
                        const data = new Uint8Array(event.target.result);
                        const workbook = window.XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = window.XLSX.utils.sheet_to_json(worksheet, { 
                            header: ['id', 'image', 'name', 'nationalId', 'mobile', 'currentService', 'address', 'dob', 'qualification', 'job', 'confessionFather'],
                            range: 4 
                        });
                        
                        let importedCount = 0;
                        for (const servant of json) {
                            if (!servant.name) continue;
                            if (servant.dob && !isNaN(servant.dob)) {
                                const dobNumber = Number(servant.dob);
                                if (dobNumber > 1) {
                                    const excelDate = new Date((dobNumber - 25569) * 86400 * 1000);
                                    if (!isNaN(excelDate.getTime())) {
                                        servant.dob = excelDate.toISOString().split('T')[0];
                                    } else {
                                        servant.dob = null;
                                    }
                                }
                            }
                            await addServant(servant);
                            importedCount++;
                        }
                        closeModal(DOMElements.importModal);
                        DOMElements.importForm.reset();
                        showMessage(`تم استيراد ${importedCount} خادم بنجاح.`);
                    } catch (err) {
                        showMessage('حدث خطأ أثناء قراءة الملف.', true);
                        console.error(err);
                    } finally {
                        showLoading(false);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            DOMElements.servantsTableBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) handleEditClick(editBtn.dataset.id);
                if (deleteBtn) deleteServant(deleteBtn.dataset.id);
            });

            DOMElements.servantImageFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        DOMElements.imagePreview.src = event.target.result;
                        DOMElements.imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Attendance Page Listeners
            DOMElements.yearSelector.addEventListener('change', async () => {
                const year = DOMElements.yearSelector.value;
                DOMElements.monthSelector.disabled = true;
                DOMElements.fridaysGrid.innerHTML = '';
                DOMElements.activityButtons.classList.add('hidden-view');
                DOMElements.attendanceListContainer.classList.add('hidden-view');
                if (year) {
                    showLoading(true);
                    await loadAttendanceForYear(year);
                    showLoading(false);
                    populateMonths(year);
                } else {
                    DOMElements.monthSelector.innerHTML = '<option value="">اختر شهر</option>';
                }
            });

            DOMElements.monthSelector.addEventListener('change', async () => {
                const year = parseInt(DOMElements.yearSelector.value);
                const month = parseInt(DOMElements.monthSelector.value);
                if (!isNaN(year) && !isNaN(month) && month >= 0) {
                    populateFridaysGrid(year, month);
                } else {
                    DOMElements.fridaysGrid.innerHTML = '';
                }
                DOMElements.activityButtons.classList.add('hidden-view');
                DOMElements.attendanceListContainer.classList.add('hidden-view');
            });

            DOMElements.fridaysGrid.addEventListener('click', (e) => {
                const button = e.target.closest('.friday-btn');
                if (button) {
                    document.querySelectorAll('.friday-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    selectedFriday = button.dataset.date;
                    updateActivityButtonsStatus(selectedFriday);
                    DOMElements.attendanceListContainer.classList.add('hidden-view');
                }
            });

            DOMElements.activityButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.activity-btn');
                if (button) {
                    const activity = button.dataset.activity;
                    if (selectedFriday) {
                        showActivityChecklist(activity, selectedFriday);
                    } else {
                        showMessage("الرجاء اختيار يوم الجمعة أولاً.", true);
                    }
                }
            });
            
            DOMElements.saveActivityAttendanceBtn.addEventListener('click', saveActivityAttendance);


            // Reports Page Listeners
            document.getElementById('reportTabs').addEventListener('click', (e) => {
                const tab = e.target.closest('.report-tab');
                if (tab) {
                    document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentReportType = tab.dataset.reportType;
                    DOMElements.reportOutput.classList.add('hidden-view');
                    if (currentReportType === 'individual') {
                        DOMElements.servantSelectorContainer.classList.remove('hidden-view');
                    } else {
                        DOMElements.servantSelectorContainer.classList.add('hidden-view');
                    }
                }
            });
            DOMElements.reportServiceSelector.addEventListener('change', () => {
                const selectedService = DOMElements.reportServiceSelector.value;
                const filteredServants = selectedService === 'all'
                    ? allServantsCache 
                    : allServantsCache.filter(s => s.serviceName === selectedService);
                populateReportServantSelector(filteredServants);
            });
            DOMElements.generateReportBtn.addEventListener('click', triggerReportGeneration);
            DOMElements.exportPngBtn.addEventListener('click', exportAsImage);
            DOMElements.exportPdfBtn.addEventListener('click', exportAsPdf);
            
            // Mobile Sidebar Listeners
            DOMElements.hamburgerBtn.addEventListener('click', () => {
                DOMElements.sidebar.classList.remove('translate-x-full');
                DOMElements.sidebarOverlay.classList.remove('hidden');
            });
            DOMElements.sidebarOverlay.addEventListener('click', () => {
                DOMElements.sidebar.classList.add('translate-x-full');
                DOMElements.sidebarOverlay.classList.add('hidden');
            });
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            DOMElements = {
                loadingOverlay: document.getElementById('loadingOverlay'),
                loginOrServicesView: document.getElementById('loginOrServicesView'),
                mainDashboard: document.getElementById('mainDashboard'),
                servicesGrid: document.getElementById('servicesGrid'),
                sidebar: document.getElementById('sidebar'),
                sidebarLinks: document.getElementById('sidebarLinks'),
                sidebarOverlay: document.getElementById('sidebarOverlay'),
                hamburgerBtn: document.getElementById('hamburgerBtn'),
                mobilePageTitle: document.getElementById('mobilePageTitle'),
                servantsTableBody: document.getElementById('servantsTableBody'),
                serviceColumnHeader: document.getElementById('serviceColumnHeader'),
                logoutBtn: document.getElementById('logoutBtn'),
                backToServicesBtn: document.getElementById('backToServices'),
                loginModal: document.getElementById('loginModal'),
                manualEntryModal: document.getElementById('manualEntryModal'),
                importModal: document.getElementById('importModal'),
                confirmModal: document.getElementById('confirmModal'),
                loginForm: document.getElementById('loginForm'),
                codeInput: document.getElementById('codeInput'),
                errorMessage: document.getElementById('errorMessage'),
                manualEntryForm: document.getElementById('manualEntryForm'),
                manualEntryModalTitle: document.getElementById('manualEntryModalTitle'),
                importForm: document.getElementById('importForm'),
                servantImageFile: document.getElementById('servantImageFile'),
                imagePreview: document.getElementById('imagePreview'),
                yearSelector: document.getElementById('yearSelector'),
                monthSelector: document.getElementById('monthSelector'),
                fridaysGrid: document.getElementById('fridaysGrid'),
                activityButtons: document.getElementById('activityButtons'),
                attendanceListContainer: document.getElementById('attendanceListContainer'),
                attendanceListTitle: document.getElementById('attendanceListTitle'),
                servantsChecklist: document.getElementById('servantsChecklist'),
                saveActivityAttendanceBtn: document.getElementById('saveActivityAttendanceBtn'),
                searchInput: document.getElementById('searchInput'),
                reportContent: document.getElementById('reportContent'),
                reportOutput: document.getElementById('reportOutput'),
                generateReportBtn: document.getElementById('generateReportBtn'),
                reportStartDate: document.getElementById('reportStartDate'),
                reportEndDate: document.getElementById('reportEndDate'),
                exportPngBtn: document.getElementById('exportPngBtn'),
                exportPdfBtn: document.getElementById('exportPdfBtn'),
                reportServantSelector: document.getElementById('reportServantSelector'),
                servantSelectorContainer: document.getElementById('servantSelectorContainer'),
                noActivityCheck: document.getElementById('noActivityCheck'),
                noActivityLabel: document.getElementById('noActivityLabel'),
                noActivityReason: document.getElementById('noActivityReason'),
                servantsActions: document.getElementById('servantsActions'),
                serviceFilterContainer: document.getElementById('serviceFilterContainer'),
                reportServiceSelector: document.getElementById('reportServiceSelector'),
                backupRestoreSection: document.getElementById('backupRestoreSection'),
                backupBtn: document.getElementById('backupBtn'),
                restoreBtn: document.getElementById('restoreBtn'),
                totalServantsStat: document.getElementById('totalServantsStat'),
                upcomingBirthdayStat: document.getElementById('upcomingBirthdayStat'),
                quickAddServant: document.getElementById('quickAddServant'),
                quickGoToAttendance: document.getElementById('quickGoToAttendance'),
                serviceDashboardContainer: document.getElementById('serviceDashboardContainer'),
                adminDashboardContainer: document.getElementById('adminDashboardContainer'),
                adminTotalServantsStat: document.getElementById('adminTotalServantsStat'),
                adminServantsTableBody: document.getElementById('adminServantsTableBody'),
                adminSearchInput: document.getElementById('adminSearchInput'),
            };

            initializeFirebase();
            populateServices();
            initializeEventListeners();
        });

    </script>
</body>
</html>
