<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الخدمة بالكنيسة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo for Arabic text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- SheetJS (xlsx) library for Excel file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for statistics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF and html2canvas for exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .hidden-view { display: none !important; }
        #mainDashboard.hidden-view { display: none !important; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link.active { 
            background-color: #06b6d4; /* cyan-500 */
            color: white; 
            border-right: 4px solid #0e7490; /* cyan-700 */
        }
        .sidebar-link:hover {
            background-color: #ccfbf1; /* teal-100 */
            color: #115e59; /* teal-800 */
        }
        .dark .sidebar-link.active {
             background-color: #0e7490; /* cyan-700 */
        }
        .dark .sidebar-link:hover {
            background-color: #134e4a; /* teal-900 */
            color: #ccfbf1; /* teal-100 */
        }
        .activity-btn.active, .friday-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 2px solid #0e7490;
        }
        .report-tab.active {
            border-color: #06b6d4;
            background-color: #06b6d4;
            color: white;
        }
        /* Style for date input placeholder */
        input[type="date"]:required:invalid::-webkit-datetime-edit {
            color: transparent;
        }
        input[type="date"]:focus::-webkit-datetime-edit {
            color: black !important;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #06b6d4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="loadingOverlay" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="loader"></div>
    </div>

    <!-- Login/Services View -->
    <div id="loginOrServicesView">
        <div class="container mx-auto px-4 py-8 md:py-12">
            <header class="text-center mb-10">
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-600 dark:text-cyan-400">نظام إدارة الخدمة بالكنيسة</h1>
                <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">اختر الخدمة التي تريد الدخول إليها</p>
            </header>
            <main id="servicesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <!-- Service Cards populated by JS -->
            </main>
        </div>
    </div>

    <!-- Main Dashboard View (Initially Hidden) -->
    <div id="mainDashboard" class="hidden-view">
        <div class="flex h-screen bg-gray-100 dark:bg-gray-800">
            <!-- Sidebar -->
            <nav id="sidebar" class="w-64 bg-white dark:bg-gray-900 shadow-lg flex flex-col">
                <div class="p-4 border-b dark:border-gray-700 text-center">
                    <h2 class="text-xl font-bold text-cyan-600 dark:text-cyan-400">قائمة التحكم</h2>
                    <p id="sidebarServiceName" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <div class="flex-grow pt-4">
                    <a href="#" data-page="homePage" class="sidebar-link active flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-home ml-3 w-6 text-center"></i> الصفحة الرئيسية</a>
                    <a href="#" data-page="servantsPage" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-users ml-3 w-6 text-center"></i> إدارة الخدام</a>
                    <a href="#" data-page="attendancePage" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-check-square ml-3 w-6 text-center"></i> تسجيل الحضور</a>
                    <a href="#" data-page="reportsPage" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-chart-pie ml-3 w-6 text-center"></i> التقارير والإحصائيات</a>
                </div>
                <div class="p-4 border-t dark:border-gray-700 space-y-2">
                    <button id="backToServices" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                        <i class="fas fa-arrow-right-from-bracket ml-2"></i> العودة للخدمات
                    </button>
                    <button id="logoutBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">تسجيل الخروج</button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 p-6 md:p-10 overflow-y-auto bg-gray-100 dark:bg-gray-800">
                <!-- Page: Home -->
                <div id="homePage" class="page-content">
                    <h1 class="text-3xl font-bold mb-4">مرحباً بك في نظام إدارة الخدمة</h1>
                    <p>استخدم القائمة الجانبية للتنقل بين أقسام النظام المختلفة.</p>
                </div>
                
                <!-- Page: Servants Management -->
                <div id="servantsPage" class="page-content hidden-view">
                     <h1 class="text-3xl font-bold mb-6">إدارة الخدام</h1>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <div class="relative flex-grow">
                            <input type="text" id="searchInput" placeholder="ابحث بالاسم أو الموبايل..." class="w-full p-3 pr-10 rounded-lg bg-white dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 focus:border-cyan-500 focus:outline-none">
                            <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button id="addManualBtn" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:shadow-lg transition-all"><i class="fas fa-plus mr-2"></i> إضافة خادم</button>
                        <button id="importExcelBtn" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:shadow-lg transition-all"><i class="fas fa-file-excel mr-2"></i> استيراد Excel</button>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-x-auto">
                        <table class="w-full text-right min-w-[1200px]">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="p-4 font-bold">الصورة</th>
                                    <th class="p-4 font-bold">الاسم</th>
                                    <th class="p-4 font-bold">الموبايل</th>
                                    <th class="p-4 font-bold">ت. الميلاد</th>
                                    <th class="p-4 font-bold">الرقم القومي</th>
                                    <th class="p-4 font-bold">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="servantsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Page: Attendance -->
                <div id="attendancePage" class="page-content hidden-view">
                     <h1 class="text-3xl font-bold mb-6">تسجيل حضور الأنشطة</h1>
                     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label for="yearSelector" class="block mb-2 font-bold">اختر السنة:</label>
                                <select id="yearSelector" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"></select>
                            </div>
                            <div>
                                <label for="monthSelector" class="block mb-2 font-bold">اختر الشهر:</label>
                                <select id="monthSelector" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" disabled></select>
                            </div>
                        </div>
                        <div id="fridaysGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6"></div>

                        <div id="activityButtons" class="hidden-view grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-6">
                            <!-- Activity buttons are generated by JS now -->
                        </div>
                        <div id="attendanceListContainer" class="hidden-view mt-6 border-t pt-6">
                            <h3 id="attendanceListTitle" class="text-xl font-bold mb-4"></h3>
                            <div id="noActivitySection" class="mb-4 p-3 bg-yellow-100 dark:bg-yellow-800 border-r-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 rounded-md">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="noActivityCheck" class="ml-3 h-5 w-5 rounded text-cyan-600 focus:ring-cyan-500">
                                    <span id="noActivityLabel"></span>
                                </label>
                                <textarea id="noActivityReason" placeholder="اكتب السبب أو الملاحظة هنا..." class="w-full p-2 mt-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 hidden"></textarea>
                            </div>
                            <div id="servantsChecklist" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2"></div>
                            <button id="saveActivityAttendanceBtn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:shadow-lg transition-all"><i class="fas fa-save mr-2"></i> حفظ الحضور</button>
                        </div>
                     </div>
                </div>

                <!-- Page: Reports (NEW STRUCTURE) -->
                <div id="reportsPage" class="page-content hidden-view">
                    <h1 class="text-3xl font-bold mb-6">التقارير والإحصائيات</h1>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <!-- Report Controls -->
                        <div class="border-b pb-4 mb-4">
                            <div class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                                <button data-report-type="individual" class="report-tab active flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300">تقرير فردي</button>
                                <button data-report-type="comprehensive" class="report-tab flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300">تقرير شامل</button>
                                <button data-report-type="averages" class="report-tab flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300">تقرير المتوسطات</button>
                            </div>

                            <!-- Filters Section -->
                            <div id="reportFilters" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div id="servantSelectorContainer">
                                        <label for="reportServantSelector" class="block mb-2 font-bold text-sm">اختر خادم:</label>
                                        <select id="reportServantSelector" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                            <!-- Options will be populated by JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="reportStartDate" class="block mb-2 font-bold text-sm">من تاريخ:</label>
                                        <input type="date" id="reportStartDate" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                    </div>
                                    <div>
                                        <label for="reportEndDate" class="block mb-2 font-bold text-sm">إلى تاريخ:</label>
                                        <input type="date" id="reportEndDate" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                    </div>
                                </div>
                                <button id="generateReportBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all">
                                    <i class="fas fa-cogs mr-2"></i> إنشاء التقرير
                                </button>
                            </div>
                        </div>

                        <!-- Report Content & Export -->
                        <div id="reportOutput" class="hidden-view">
                            <div id="reportContent" class="my-6">
                                <!-- Generated report (table or chart) will be injected here -->
                            </div>
                            <div id="exportButtons" class="flex justify-end gap-4 border-t pt-4">
                                <button id="exportPngBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all"><i class="fas fa-file-image mr-2"></i> تصدير كصورة (PNG)</button>
                                <button id="exportPdfBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all"><i class="fas fa-file-pdf mr-2"></i> تصدير كملف (PDF)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="loginModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <div class="flex justify-between items-center pb-3">
                <h3 id="modalTitle" class="text-2xl font-bold"></h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl">&times;</button>
            </div>
            <form id="loginForm" class="mt-4">
                <p class="text-md mb-4">الرجاء إدخال كود الدخول المكون من 6 أرقام.</p>
                <input id="codeInput" type="number" placeholder="******" class="w-full px-4 py-3 text-lg text-center tracking-[1em] bg-gray-100 dark:bg-gray-700 border-2 rounded-lg focus:outline-none focus:border-cyan-500">
                <p id="errorMessage" class="text-red-500 text-sm mt-2 h-5"></p>
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg mt-4">دخــــول</button>
            </form>
        </div>
    </div>
    <div id="manualEntryModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-lg mx-auto rounded-xl shadow-lg z-50 p-8 max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center pb-3">
                <h3 id="manualEntryModalTitle" class="text-2xl font-bold">إضافة خادم جديد</h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl">&times;</button>
            </div>
            <form id="manualEntryForm" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="servantId">
                <input type="text" id="servantName" placeholder="الاسم بالكامل" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg md:col-span-2">
                <input type="tel" id="servantMobile" placeholder="رقم الموبايل" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <input type="date" id="servantDob" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300">
                <input type="text" id="servantNationalId" placeholder="الرقم القومي" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg md:col-span-2">
                <input type="text" id="servantCurrentService" placeholder="الخدمة الحالية" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <input type="text" id="servantJob" placeholder="الوظيفة" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <textarea id="servantAddress" placeholder="العنوان" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg md:col-span-2"></textarea>
                <input type="text" id="servantQualification" placeholder="المؤهل" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <input type="text" id="servantConfessionFather" placeholder="أب الاعتراف" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <div class="md:col-span-2">
                    <label class="block mb-2 text-sm font-medium">صورة الخادم (اختياري)</label>
                    <input type="file" id="servantImageFile" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                    <img id="imagePreview" src="" alt="Image Preview" class="mt-4 rounded-lg max-h-40 hidden"/>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg md:col-span-2">حفظ البيانات</button>
            </form>
        </div>
    </div>
    <div id="importModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <div class="flex justify-between items-center pb-3">
                <h3 class="text-2xl font-bold">استيراد من Excel</h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl">&times;</button>
            </div>
            <form id="importForm" class="mt-4">
                <p class="text-md mb-4">اختر ملف Excel (.xlsx, .xls). سيتم البدء من الصف الخامس.</p>
                <input type="file" id="excelFile" accept=".xlsx, .xls" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg mt-4">استيراد</button>
            </form>
        </div>
    </div>
    <div id="confirmModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <h3 id="confirmModalTitle" class="text-xl font-bold mb-4">تأكيد الإجراء</h3>
            <p id="confirmModalBody" class="mb-6">هل أنت متأكد من أنك تريد المتابعة؟</p>
            <div class="flex justify-end gap-4">
                <button id="confirmModalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
                <button id="confirmModalConfirmBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">تأكيد</button>
            </div>
        </div>
    </div>
    <div id="messageBox" class="hidden fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl z-50"></div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, getDoc, getDocs, updateDoc, writeBatch, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARS & STATE ---
        const services = [
            { name: "خدمة B.C", icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>', color: 'cyan' },
            { name: "خدمة أولى ابتدائي", icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"></path>', color: 'green' },
            { name: "خدمة ثانية ابتدائي", icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.373 3.373 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>', color: 'yellow' },
            { name: "خدمة ثالثة ورابعة بنات", icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6a6 6 0 016 6v1h-3"></path>', color: 'pink' },
            { name: "خدمة ثالثة ورابعة أولاد", icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>', color: 'indigo' },
            { name: "خدمة خامسة وسادسة بنات", icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>', color: 'red' },
            { name: "خدمة خامسة وسادسة أولاد", icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>', color: 'purple' },
            { name: "خدمة الكورال والأنشطة", icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3"></path>', color: 'teal' },
            { name: "خدمة وسائل الإيضاح", icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>', color: 'orange' },
        ];
        const CORRECT_CODE = '123456';
        let currentServiceName = '';
        let db, auth, userId, servantsUnsubscribe = null;
        let servantsCache = [];
        let attendanceCache = [];
        let currentActivity = '';
        let selectedFriday = '';
        let activityAttendanceChart = null;
        let currentReportType = 'individual';
        let monthlyAttendanceCache = {};
        
        const activities = [
            { key: 'visiting', name: 'الافتقاد', icon: 'fa-hand-holding-heart', color: 'bg-orange-500', hover: 'hover:bg-orange-600' },
            { key: 'preparation', name: 'التحضير', icon: 'fa-book-open', color: 'bg-yellow-500', hover: 'hover:bg-yellow-600' },
            { key: 'mass', name: 'القداس', icon: 'fa-cross', color: 'bg-red-500', hover: 'hover:bg-red-600' },
            { key: 'service', name: 'الخدمة', icon: 'fa-church', color: 'bg-blue-500', hover: 'hover:bg-blue-600' },
            { key: 'explanation', name: 'الشرح', icon: 'fa-chalkboard-teacher', color: 'bg-green-500', hover: 'hover:bg-green-600' }
        ];
        const activityMap = new Map(activities.map(a => [a.key, a]));

        // --- DOM ELEMENTS ---
        const loginOrServicesView = document.getElementById('loginOrServicesView');
        const mainDashboard = document.getElementById('mainDashboard');
        const servicesGrid = document.getElementById('servicesGrid');
        const servantsTableBody = document.getElementById('servantsTableBody');
        const sidebar = document.getElementById('sidebar');
        const logoutBtn = document.getElementById('logoutBtn');
        const backToServicesBtn = document.getElementById('backToServices');
        const loginModal = document.getElementById('loginModal');
        const manualEntryModal = document.getElementById('manualEntryModal');
        const importModal = document.getElementById('importModal');
        const confirmModal = document.getElementById('confirmModal');
        const loginForm = document.getElementById('loginForm');
        const codeInput = document.getElementById('codeInput');
        const errorMessage = document.getElementById('errorMessage');
        const manualEntryForm = document.getElementById('manualEntryForm');
        const importForm = document.getElementById('importForm');
        const servantImageFileInput = document.getElementById('servantImageFile');
        const imagePreview = document.getElementById('imagePreview');
        const yearSelector = document.getElementById('yearSelector');
        const monthSelector = document.getElementById('monthSelector');
        const fridaysGrid = document.getElementById('fridaysGrid');
        const activityButtons = document.getElementById('activityButtons');
        const attendanceListContainer = document.getElementById('attendanceListContainer');
        const attendanceListTitle = document.getElementById('attendanceListTitle');
        const servantsChecklist = document.getElementById('servantsChecklist');
        const saveActivityAttendanceBtn = document.getElementById('saveActivityAttendanceBtn');
        const searchInput = document.getElementById('searchInput');
        const reportContent = document.getElementById('reportContent');
        const reportOutput = document.getElementById('reportOutput');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportStartDate = document.getElementById('reportStartDate');
        const reportEndDate = document.getElementById('reportEndDate');
        const exportPngBtn = document.getElementById('exportPngBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const reportServantSelector = document.getElementById('reportServantSelector');
        const servantSelectorContainer = document.getElementById('servantSelectorContainer');
        const noActivityCheck = document.getElementById('noActivityCheck');
        const noActivityLabel = document.getElementById('noActivityLabel');
        const noActivityReason = document.getElementById('noActivityReason');

        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = {
  apiKey: "AIzaSyDqnWPGTAvIWakd0Wl14uuznrCy2oo8Iws",
  authDomain: "church-service-app-4f180.firebaseapp.com",
  projectId: "church-service-app-4f180",
  storageBucket: "church-service-app-4f180.firebasestorage.app",
  messagingSenderId: "431475695196",
  appId: "1:431475695196:web:4bd4389448eb94804e1099"
};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Sign-in failed:", error);
                            showMessage("فشل الاتصال بقاعدة البيانات", true);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("فشل تهيئة النظام.", true);
            }
        }

        // --- UTILITY & UI FUNCTIONS ---
        const showMessage = (text, isError = false) => {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 3000);
        };

        const openModal = (modal) => {
            modal.classList.remove('hidden-view');
            modal.classList.add('flex');
        };
        const closeModal = (modal) => {
            modal.classList.add('hidden-view');
            modal.classList.remove('flex');
        };

        const populateServices = () => {
            servicesGrid.innerHTML = '';
            services.forEach(service => {
                const card = `<div class="service-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transform transition-all duration-300 cursor-pointer flex flex-col items-center text-center" data-service-name="${service.name}"><div class="bg-${service.color}-100 dark:bg-${service.color}-900 p-4 rounded-full mb-4"><svg class="w-10 h-10 text-${service.color}-500 dark:text-${service.color}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${service.icon}</svg></div><h3 class="text-xl font-bold">${service.name}</h3></div>`;
                servicesGrid.insertAdjacentHTML('beforeend', card);
            });
        };

        const showConfirm = (title, body, onConfirm) => {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').textContent = body;
            openModal(confirmModal);

            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            const cancelBtn = document.getElementById('confirmModalCancelBtn');

            const confirmHandler = () => {
                onConfirm();
                closeModal(confirmModal);
                cleanup();
            };
            const cancelHandler = () => {
                closeModal(confirmModal);
                cleanup();
            };
            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        };
        
        async function showDashboard() {
            loginOrServicesView.classList.add('hidden-view');
            mainDashboard.classList.remove('hidden-view');
            document.getElementById('sidebarServiceName').textContent = currentServiceName;
            await loadServants();
            await loadAttendanceDataForReports();
        }

        function returnToMainMenu() {
            mainDashboard.classList.add('hidden-view');
            loginOrServicesView.classList.remove('hidden-view');
            document.getElementById('sidebarServiceName').textContent = '';
            currentServiceName = '';
            if (servantsUnsubscribe) servantsUnsubscribe();
            servantsCache = [];
            attendanceCache = [];
        }
        
        async function switchPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden-view'));
            document.getElementById(pageId).classList.remove('hidden-view');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-page="${pageId}"]`).classList.add('active');
            
            if (pageId === 'attendancePage') loadAttendancePage();
            if (pageId === 'reportsPage') {
                await loadAttendanceDataForReports();
                loadReportsPage();
            }
        }

        // --- SERVANTS MANAGEMENT ---
        function renderServantsTable(servantsToRender) {
            servantsTableBody.innerHTML = '';
            servantsToRender.forEach(servant => addServantToTable(servant));
        }

        function addServantToTable(servant) {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50';
            const imageUrl = servant.imageUrl || 'https://placehold.co/60x60/E2E8F0/4A5568?text=?';
            const val = (data) => data || 'غير متوفر';
            row.innerHTML = `
                <td class="p-4"><img src="${imageUrl}" alt="صورة" class="w-14 h-14 rounded-full object-cover"></td>
                <td class="p-4 font-semibold">${val(servant.name)}</td>
                <td class="p-4">${val(servant.mobile)}</td>
                <td class="p-4">${val(servant.dob)}</td>
                <td class="p-4">${val(servant.nationalId)}</td>
                <td class="p-4 space-x-2 whitespace-nowrap">
                    <button class="text-blue-500 hover:text-blue-700 edit-btn" data-id="${servant.id}"><i class="fas fa-edit"></i> تعديل</button>
                    <button class="text-red-500 hover:text-red-700 delete-btn" data-id="${servant.id}"><i class="fas fa-trash"></i> حذف</button>
                </td>`;
            servantsTableBody.appendChild(row);
        }

        function loadServants() {
            return new Promise((resolve) => {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                if (!userId || !currentServiceName) return resolve();
                const servantsCol = collection(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/servants`);
                
                if (servantsUnsubscribe) servantsUnsubscribe();
                
                servantsUnsubscribe = onSnapshot(servantsCol, (snapshot) => {
                    servantsCache = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    servantsCache.sort((a, b) => (a.name || '').localeCompare((b.name || ''), 'ar'));
                    renderServantsTable(servantsCache);
                    populateReportServantSelector();
                    resolve();
                }, (error) => {
                    console.error("Error loading servants:", error);
                    showMessage("خطأ في تحميل بيانات الخدام.", true);
                    resolve();
                });
            });
        }
        
        function resizeAndEncodeImage(file) {
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null);

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400;
                        const MAX_HEIGHT = 400;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        async function handleServantFormSubmit(e) {
            e.preventDefault();
            
            const dobInput = document.getElementById('servantDob');
            const dobValue = dobInput.value;
            const dobDate = new Date(dobValue);

            if (!dobValue || isNaN(dobDate.getTime()) || dobDate.getFullYear() > new Date().getFullYear() || dobDate.getFullYear() < 1920) {
                showMessage("الرجاء إدخال تاريخ ميلاد صحيح (بين عام 1920 والعام الحالي).", true);
                dobInput.focus();
                return;
            }

            const servantId = document.getElementById('servantId').value;
            const imageFile = servantImageFileInput.files[0];

            let servantData = {
                name: document.getElementById('servantName').value,
                mobile: document.getElementById('servantMobile').value,
                dob: dobValue,
                nationalId: document.getElementById('servantNationalId').value,
                currentService: document.getElementById('servantCurrentService').value,
                address: document.getElementById('servantAddress').value,
                qualification: document.getElementById('servantQualification').value,
                job: document.getElementById('servantJob').value,
                confessionFather: document.getElementById('servantConfessionFather').value,
            };

            try {
                if (imageFile) {
                    const imageUrl = await resizeAndEncodeImage(imageFile);
                    if (imageUrl) {
                        servantData.imageUrl = imageUrl;
                    }
                }

                if (servantId) {
                    await updateServant(servantId, servantData);
                } else {
                    await addServant(servantData);
                }

                closeModal(manualEntryModal);
            } catch (error) {
                showMessage('حدث خطأ أثناء معالجة الصورة.', true);
                console.error(error);
            }
        }

        async function addServant(servantData) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                const servantsCol = collection(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/servants`);
                await addDoc(servantsCol, servantData);
                showMessage("تم إضافة الخادم بنجاح!");
            } catch (error) {
                console.error("Error adding servant:", error);
                showMessage("فشل إضافة الخادم.", true);
            }
        }

        async function updateServant(servantId, servantData) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                const servantDoc = doc(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/servants`, servantId);
                await updateDoc(servantDoc, servantData);
                showMessage("تم تحديث بيانات الخادم بنجاح!");
            } catch (error) {
                console.error("Error updating servant:", error);
                showMessage("فشل تحديث بيانات الخادم.", true);
            }
        }

        async function deleteServant(servantId) {
             const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
             if (!userId || !currentServiceName || !servantId) return;
             
             showConfirm('تأكيد الحذف', 'هل أنت متأكد من حذف هذا الخادم؟ سيتم حذف جميع بياناته بشكل نهائي.', async () => {
                try {
                    const servantDoc = doc(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/servants`, servantId);
                    await deleteDoc(servantDoc);
                    showMessage("تم حذف الخادم.");
                } catch(error) {
                    console.error("Error deleting servant: ", error);
                    showMessage("فشل حذف الخادم.", true);
                }
             });
        }
        
        function handleEditClick(servantId) {
            const servant = servantsCache.find(s => s.id === servantId);
            if (!servant) return;

            document.getElementById('manualEntryModalTitle').textContent = 'تعديل بيانات خادم';
            manualEntryForm.reset();
            imagePreview.classList.add('hidden');
            imagePreview.src = '';

            document.getElementById('servantId').value = servant.id;
            document.getElementById('servantName').value = servant.name || '';
            document.getElementById('servantMobile').value = servant.mobile || '';
            document.getElementById('servantDob').value = servant.dob || '';
            document.getElementById('servantNationalId').value = servant.nationalId || '';
            document.getElementById('servantCurrentService').value = servant.currentService || '';
            document.getElementById('servantAddress').value = servant.address || '';
            document.getElementById('servantQualification').value = servant.qualification || '';
            document.getElementById('servantJob').value = servant.job || '';
            document.getElementById('servantConfessionFather').value = servant.confessionFather || '';
            
            if (servant.imageUrl) {
                imagePreview.src = servant.imageUrl;
                imagePreview.classList.remove('hidden');
            }

            openModal(manualEntryModal);
        }

        // --- ATTENDANCE MANAGEMENT ---
        function populateMonths(year) {
            monthSelector.innerHTML = '<option value="">اختر شهر</option>';
            const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            months.forEach((month, index) => {
                monthSelector.innerHTML += `<option value="${index}">${month}</option>`;
            });
            monthSelector.disabled = false;
        }

        async function populateFridaysGrid(year, month) {
            fridaysGrid.innerHTML = '';
            const fridays = [];
            const date = new Date(year, month, 1);
            while (date.getMonth() === month) {
                if (date.getDay() === 5) { // 5 is for Friday
                    fridays.push(new Date(date.getTime()));
                }
                date.setDate(date.getDate() + 1);
            }

            for (const friday of fridays) {
                const y = friday.getFullYear();
                const m = (friday.getMonth() + 1).toString().padStart(2, '0');
                const d = friday.getDate().toString().padStart(2, '0');
                const dateString = `${y}-${m}-${d}`;
                
                const day = friday.getDate();
                let buttonHTML = `<button data-date="${dateString}" class="friday-btn p-3 rounded-lg bg-cyan-500 text-white font-bold transition-all duration-200 shadow hover:shadow-lg hover:bg-cyan-600 relative">${day}`;
                
                const dayData = monthlyAttendanceCache[dateString] || {};
                
                let dotsHTML = '<div class="absolute bottom-1 right-1 flex space-x-1 space-x-reverse">';
                activities.forEach(act => {
                    const color = dayData[act.key] ? act.color.replace('hover:', '') : 'bg-gray-300';
                    dotsHTML += `<span class="block w-2 h-2 ${color} rounded-full"></span>`;
                });
                dotsHTML += '</div>';

                buttonHTML += dotsHTML;
                buttonHTML += `</button>`;
                fridaysGrid.insertAdjacentHTML('beforeend', buttonHTML);
            }
        }

        function loadAttendancePage() {
            yearSelector.innerHTML = '<option value="">اختر سنة</option>';
            for (let i = 2030; i >= 2025; i--) {
                yearSelector.innerHTML += `<option value="${i}">${i}</option>`;
            }
            monthSelector.innerHTML = '<option value="">اختر شهر</option>';
            monthSelector.disabled = true;
            fridaysGrid.innerHTML = '';
            activityButtons.innerHTML = ''; // Clear previous buttons
            activityButtons.classList.add('hidden-view');
            attendanceListContainer.classList.add('hidden-view');
        }
        
        async function updateActivityButtonsStatus(date) {
            const dayDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/services/${currentServiceName}/attendance`, date);
            const dayDocSnap = await getDoc(dayDocRef);
            const dayData = dayDocSnap.exists() ? dayDocSnap.data() : {};

            activityButtons.innerHTML = ''; // Clear and rebuild
            activities.forEach(act => {
                const activityData = dayData[act.key];
                let statusIcon = '';
                let statusText = '';
                
                if (activityData) {
                    if (activityData.note !== null && activityData.note !== undefined) {
                        statusIcon = `<i class="fas fa-exclamation-circle text-yellow-300 ml-2"></i>`;
                        statusText = `<span class="text-xs font-normal">ملغى</span>`;
                    } else if (activityData.attendees) {
                        statusIcon = `<i class="fas fa-check-circle text-green-300 ml-2"></i>`;
                        statusText = `<span class="text-xs font-normal">${activityData.attendees.length}/${servantsCache.length} حاضر</span>`;
                    }
                }

                activityButtons.innerHTML += `
                    <button data-activity="${act.key}" class="activity-btn p-3 rounded-lg text-white font-bold transition-all duration-200 shadow hover:shadow-lg ${act.color} ${act.hover} flex flex-col items-center justify-center">
                        <div><i class="fas ${act.icon} mr-2"></i><span>${act.name}</span></div>
                        <div class="mt-1 h-4">${statusIcon}${statusText}</div>
                    </button>`;
            });
            activityButtons.classList.remove('hidden-view');
        }


        async function showActivityChecklist(activityKey, date) {
            currentActivity = activityKey;
            const activity = activityMap.get(activityKey);
            
            document.querySelectorAll('.activity-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.activity-btn[data-activity="${activityKey}"]`).classList.add('active');
            
            const [year, month, day] = date.split('-').map(Number);
            const displayDate = new Date(year, month - 1, day);
            const formattedDate = displayDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            attendanceListTitle.textContent = `تسجيل حضور: ${activity.name} - ${formattedDate}`;
            servantsChecklist.innerHTML = '';
            
            noActivityCheck.checked = false;
            noActivityReason.value = '';
            noActivityReason.classList.add('hidden');
            noActivityLabel.textContent = `لا يوجد ${activity.name} لهذا اليوم`;
            servantsChecklist.classList.remove('hidden');

            const dayDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/services/${currentServiceName}/attendance`, date);
            const dayDocSnap = await getDoc(dayDocRef);
            const dayData = dayDocSnap.exists() ? dayDocSnap.data() : {};
            const activityData = dayData[activityKey] || {};
            
            const attendees = activityData.attendees || [];
            
            if (activityData.note !== undefined && activityData.note !== null) {
                noActivityCheck.checked = true;
                noActivityReason.value = activityData.note;
                noActivityReason.classList.remove('hidden');
                servantsChecklist.classList.add('hidden');
            }

            const sortedServants = [...servantsCache].sort((a, b) => a.name.localeCompare(b.name, 'ar'));

            sortedServants.forEach(servant => {
                const isChecked = attendees.includes(servant.id);
                const a_id = `${activityKey}-${servant.id}`;
                servantsChecklist.innerHTML += `
                    <div class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <input id="${a_id}" type="checkbox" data-servant-id="${servant.id}" class="w-5 h-5 ml-3 rounded text-cyan-600 focus:ring-cyan-500" ${isChecked ? 'checked' : ''}>
                        <label for="${a_id}" class="cursor-pointer">${servant.name}</label>
                    </div>`;
            });
            
            attendanceListContainer.classList.remove('hidden-view');
        }

        async function saveActivityAttendance() {
            if (!selectedFriday || !currentActivity) {
                showMessage("الرجاء اختيار اليوم والنشاط أولاً.", true);
                return;
            }

            const dayDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/services/${currentServiceName}/attendance`, selectedFriday);
            const updates = {};
            
            if (noActivityCheck.checked) {
                updates[currentActivity] = {
                    attendees: [],
                    note: noActivityReason.value || 'تم الإلغاء'
                };
            } else {
                const attendees = [];
                document.querySelectorAll('#servantsChecklist input[type="checkbox"]:checked').forEach(checkbox => {
                    attendees.push(checkbox.dataset.servantId);
                });
                updates[currentActivity] = { attendees: attendees, note: null };
            }

            try {
                await setDoc(dayDocRef, updates, { merge: true });
                const activityName = activityMap.get(currentActivity).name;
                showMessage(`تم حفظ حضور "${activityName}" بنجاح.`);
                attendanceListContainer.classList.add('hidden-view');
                document.querySelectorAll('.activity-btn').forEach(btn => btn.classList.remove('active'));
                await loadAttendanceDataForReports(); // Full refresh for reports
                
                // Quick update for local cache and UI
                monthlyAttendanceCache[selectedFriday] = { ...monthlyAttendanceCache[selectedFriday], ...updates };
                await updateActivityButtonsStatus(selectedFriday);
                const year = parseInt(yearSelector.value);
                const month = parseInt(monthSelector.value);
                if (year && month >= 0) {
                    populateFridaysGrid(year, month);
                }

            } catch (error) {
                console.error("Error saving activity attendance:", error);
                showMessage("فشل حفظ الحضور.", true);
            }
        }

        // --- REPORTS & STATISTICS ---
        function loadAttendanceDataForReports() {
             return new Promise(async (resolve) => {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                if (!userId || !currentServiceName) {
                    attendanceCache = [];
                    return resolve();
                }
                const attendanceCol = collection(db, `artifacts/${appId}/users/${userId}/services/${currentServiceName}/attendance`);
                try {
                    const snapshot = await getDocs(attendanceCol);
                    attendanceCache = snapshot.docs.map(doc => ({ date: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Error loading attendance data for reports:", error);
                    attendanceCache = [];
                }
                resolve();
            });
        }

        function loadReportsPage() {
            reportOutput.classList.add('hidden-view');
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            reportStartDate.value = firstDayOfMonth.toISOString().split('T')[0];
            reportEndDate.value = today.toISOString().split('T')[0];
            
            document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-report-type="individual"]').classList.add('active');
            currentReportType = 'individual';
            servantSelectorContainer.classList.remove('hidden-view');
            populateReportServantSelector();
        }
        
        function populateReportServantSelector() {
            const selectedVal = reportServantSelector.value;
            reportServantSelector.innerHTML = '<option value="">-- اختر --</option>';
            reportServantSelector.innerHTML += '<option value="all">-- كل الخدام --</option>';
            servantsCache.forEach(servant => {
                reportServantSelector.innerHTML += `<option value="${servant.id}">${servant.name}</option>`;
            });
            reportServantSelector.value = selectedVal;
        }

        function triggerReportGeneration() {
            const startDate = reportStartDate.value;
            const endDate = reportEndDate.value;
            if (!startDate || !endDate) {
                showMessage("الرجاء تحديد تاريخ البداية والنهاية.", true);
                return;
            }
            if (startDate > endDate) {
                showMessage("تاريخ البداية لا يمكن أن يكون بعد تاريخ النهاية.", true);
                return;
            }

            const filteredAttendance = attendanceCache.filter(item => {
                return item.date >= startDate && item.date <= endDate;
            });

            if (currentReportType === 'individual') {
                const servantId = reportServantSelector.value;
                if (!servantId) {
                    showMessage("الرجاء اختيار خادم لعرض التقرير.", true);
                    return;
                }
                if (servantId === 'all') {
                    displayAllServantsAverageReport(filteredAttendance);
                } else {
                    displayIndividualReport(servantId, filteredAttendance);
                }
            } else if (currentReportType === 'comprehensive') {
                generateComprehensiveReport(filteredAttendance);
            } else if (currentReportType === 'averages') {
                generateAveragesReport(filteredAttendance);
            }
        }
        
        function getPercentageColor(percentage) {
            if (percentage >= 75) return 'bg-green-500';
            if (percentage >= 50) return 'bg-yellow-500';
            return 'bg-red-500';
        }
        
        function getPercentageBGColor(percentage) {
            if (percentage >= 75) return 'bg-green-100 dark:bg-green-900';
            if (percentage >= 50) return 'bg-yellow-100 dark:bg-yellow-900';
            return 'bg-red-100 dark:bg-red-900';
        }

        function displayAllServantsAverageReport(data) {
            reportContent.innerHTML = '';
            let reportHTML = `<h3 class="text-xl font-bold mb-4">متوسط الحضور لكل الأنشطة</h3>`;
            reportHTML += '<div class="grid grid-cols-2 md:grid-cols-3 gap-4">';

            const activityTotals = {};
            const activityCounts = {};
            activities.forEach(act => {
                activityTotals[act.key] = 0;
                activityCounts[act.key] = 0;
            });

            data.forEach(day => {
                activities.forEach(activity => {
                    const activityData = day[activity.key];
                    if (activityData && activityData.note === null) {
                        activityTotals[activity.key] += activityData.attendees.length;
                        activityCounts[activity.key]++;
                    }
                });
            });

            const avgAttendancePercentages = activities.map(activity => {
                const totalAttendees = activityTotals[activity.key];
                const totalMeetings = activityCounts[activity.key];
                if (totalMeetings === 0 || servantsCache.length === 0) return 0;
                return Math.round(((totalAttendees / totalMeetings) / servantsCache.length) * 100);
            });
            
            let overallPercentages = [];
            activities.forEach((activity, index) => {
                const percentage = avgAttendancePercentages[index];
                overallPercentages.push(percentage);
                reportHTML += `
                    <div class="text-center p-4 rounded-lg ${getPercentageBGColor(percentage)}">
                        <div class="font-bold text-lg">${activity.name}</div>
                        <div class="text-3xl font-bold my-2">${percentage}%</div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2">
                           <div class="${getPercentageColor(percentage)} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
            });

            const overallAverage = overallPercentages.length > 0 ? Math.round(overallPercentages.reduce((a, b) => a + b, 0) / overallPercentages.length) : 0;
             reportHTML += `
                <div class="text-center p-4 rounded-lg ${getPercentageBGColor(overallAverage)}">
                    <div class="font-bold text-lg">المتوسط العام</div>
                    <div class="text-3xl font-bold my-2">${overallAverage}%</div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2">
                        <div class="${getPercentageColor(overallAverage)} h-2.5 rounded-full" style="width: ${overallAverage}%"></div>
                    </div>
                </div>`;

            reportHTML += '</div>';
            reportContent.innerHTML = reportHTML;
            reportOutput.classList.remove('hidden-view');
        }

        function displayIndividualReport(servantId, data) {
            if (!servantId) {
                reportOutput.classList.add('hidden-view');
                return;
            }
            const servant = servantsCache.find(s => s.id === servantId);
            if (!servant) return;

            reportContent.innerHTML = ''; 

            const reportData = { total: {}, attended: {} };
            activities.forEach(act => {
                reportData.total[act.key] = 0;
                reportData.attended[act.key] = 0;
            });

            data.forEach(day => {
                activities.forEach(activity => {
                    const activityData = day[activity.key];
                    if (activityData && activityData.note === null) {
                        reportData.total[activity.key]++;
                        if (activityData.attendees && activityData.attendees.includes(servantId)) {
                            reportData.attended[activity.key]++;
                        }
                    }
                });
            });

            let reportHTML = `<h3 class="text-xl font-bold mb-4">تقرير الحضور لـ: ${servant.name}</h3>`;
            reportHTML += '<div class="grid grid-cols-2 md:grid-cols-3 gap-4">';
            
            let percentages = [];
            activities.forEach(activity => {
                const total = reportData.total[activity.key];
                const attended = reportData.attended[activity.key];
                const percentage = total > 0 ? Math.round((attended / total) * 100) : 0;
                percentages.push(percentage);

                reportHTML += `
                    <div class="text-center p-4 rounded-lg ${getPercentageBGColor(percentage)}">
                        <div class="font-bold text-lg">${activity.name}</div>
                        <div class="text-3xl font-bold my-2">${percentage}%</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">(${attended} من ${total})</div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2">
                           <div class="${getPercentageColor(percentage)} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
            });

            const overallAverage = percentages.length > 0 ? Math.round(percentages.reduce((a, b) => a + b, 0) / percentages.length) : 0;
            reportHTML += `
                <div class="text-center p-4 rounded-lg ${getPercentageBGColor(overallAverage)}">
                    <div class="font-bold text-lg">المتوسط العام</div>
                    <div class="text-3xl font-bold my-2">${overallAverage}%</div>
                     <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2">
                        <div class="${getPercentageColor(overallAverage)} h-2.5 rounded-full" style="width: ${overallAverage}%"></div>
                    </div>
                </div>`;

            reportHTML += '</div>';

            reportContent.innerHTML = reportHTML;
            reportOutput.classList.remove('hidden-view');
        }

        function generateComprehensiveReport(data) {
            reportContent.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'w-full text-right min-w-[1000px]';
            let tableHTML = `
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="p-3 font-bold">اسم الخادم</th>
            `;
            activities.forEach(act => {
                tableHTML += `<th class="p-3 font-bold">${act.name}</th>`;
            });
            tableHTML += `<th class="p-3 font-bold">المتوسط العام</th></tr></thead><tbody>`;

            servantsCache.forEach(servant => {
                let totalAttended = 0, totalMeetings = 0;
                tableHTML += `<tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50"><td class="p-3 font-semibold">${servant.name}</td>`;
                activities.forEach(act => {
                    let attended = 0, meetings = 0;
                    data.forEach(day => {
                        if (day[act.key] && day[act.key].note === null) {
                            meetings++;
                            if (day[act.key].attendees.includes(servant.id)) attended++;
                        }
                    });
                    totalAttended += attended; totalMeetings += meetings;
                    const percentage = meetings > 0 ? Math.round((attended / meetings) * 100) : 0;
                    tableHTML += `<td class="p-3 text-center">${percentage}% <span class="text-xs text-gray-500">(${attended}/${meetings})</span></td>`;
                });
                const overallPercentage = totalMeetings > 0 ? Math.round((totalAttended / totalMeetings) * 100) : 0;
                tableHTML += `<td class="p-3 text-center font-bold text-cyan-600">${overallPercentage}%</td></tr>`;
            });
            tableHTML += `</tbody>`;
            table.innerHTML = tableHTML;
            reportContent.appendChild(table);
            reportOutput.classList.remove('hidden-view');
        }

        function generateAveragesReport(data) {
            reportContent.innerHTML = '<div class="relative h-96"><canvas id="reportAverageChart"></canvas></div>';
            const ctx = document.getElementById('reportAverageChart').getContext('2d');
            const activityTotals = {}, activityCounts = {};
            activities.forEach(act => { activityTotals[act.key] = 0; activityCounts[act.key] = 0; });
            data.forEach(day => {
                activities.forEach(activity => {
                    const activityData = day[activity.key];
                    if (activityData && activityData.note === null) {
                        activityTotals[activity.key] += activityData.attendees.length;
                        activityCounts[activity.key]++;
                    }
                });
            });
            const avgAttendance = activities.map(activity => {
                const totalAttendees = activityTotals[activity.key], totalMeetings = activityCounts[activity.key];
                if (totalMeetings === 0 || servantsCache.length === 0) return 0;
                return Math.round(((totalAttendees / totalMeetings) / servantsCache.length) * 100);
            });
            if (window.reportChart instanceof Chart) window.reportChart.destroy();
            window.reportChart = new Chart(ctx, { type: 'bar', data: { labels: activities.map(a => a.name), datasets: [{ label: 'متوسط نسبة الحضور', data: avgAttendance, backgroundColor: 'rgba(6, 182, 212, 0.6)', borderColor: 'rgba(8, 145, 178, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, max: 100 } }, responsive: true, maintainAspectRatio: false } });
            reportOutput.classList.remove('hidden-view');
        }

        function exportAsImage() {
            html2canvas(reportContent).then(canvas => {
                const link = document.createElement('a');
                link.download = `report-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function exportAsPdf() {
            const { jsPDF } = window.jspdf;
            html2canvas(reportContent).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'landscape',
                });
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`report-${new Date().toISOString().slice(0,10)}.pdf`);
            });
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            populateServices();
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorMessage.textContent = '';
                if (codeInput.value === CORRECT_CODE) {
                    closeModal(loginModal);
                    codeInput.value = '';
                    await showDashboard();
                } else {
                    errorMessage.textContent = 'الكود غير صحيح. حاول مرة أخرى.';
                }
            });

            sidebar.addEventListener('click', (e) => {
                const link = e.target.closest('.sidebar-link');
                if (link) { e.preventDefault(); switchPage(link.dataset.page); }
            });
            logoutBtn.addEventListener('click', returnToMainMenu);
            backToServicesBtn.addEventListener('click', returnToMainMenu);
            
            manualEntryForm.addEventListener('submit', handleServantFormSubmit);
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredServants = servantsCache.filter(s => 
                    s.name.toLowerCase().includes(searchTerm) || 
                    (s.mobile && s.mobile.includes(searchTerm))
                );
                renderServantsTable(filteredServants);
            });
            
            servantsTableBody.addEventListener('click', (e) => {
                const targetButton = e.target.closest('button');
                if (!targetButton) return;
                
                if (targetButton.classList.contains('edit-btn')) {
                    handleEditClick(targetButton.dataset.id);
                } else if (targetButton.classList.contains('delete-btn')) {
                    deleteServant(targetButton.dataset.id);
                }
            });

            document.getElementById('addManualBtn').addEventListener('click', () => {
                document.getElementById('manualEntryModalTitle').textContent = 'إضافة خادم جديد';
                manualEntryForm.reset();
                document.getElementById('servantId').value = '';
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
                openModal(manualEntryModal);
            });
            document.getElementById('importExcelBtn').addEventListener('click', () => openModal(importModal));
            
            importForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const file = document.getElementById('excelFile').files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = window.XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = window.XLSX.utils.sheet_to_json(worksheet, { 
                            header: ['id', 'image', 'name', 'nationalId', 'mobile', 'currentService', 'address', 'dob', 'qualification', 'job', 'confessionFather'],
                            range: 4 
                        });
                        for (const servant of json) {
                            if (!servant.name) continue;
                            if (servant.dob && !isNaN(servant.dob)) {
                                const dobNumber = Number(servant.dob);
                                if (dobNumber > 1) {
                                    const excelDate = new Date((dobNumber - 25569) * 86400 * 1000);
                                    if (!isNaN(excelDate.getTime())) {
                                        servant.dob = excelDate.toISOString().split('T')[0];
                                    } else {
                                        servant.dob = null;
                                    }
                                }
                            }
                            await addServant(servant);
                        }
                        closeModal(importModal);
                        importForm.reset();
                        showMessage(`تم استيراد ${json.length} خادم بنجاح.`);
                    } catch (err) {
                        showMessage('حدث خطأ أثناء قراءة الملف.', true);
                        console.error(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            yearSelector.addEventListener('change', () => {
                const year = parseInt(yearSelector.value);
                if (year) {
                    populateMonths(year);
                } else {
                    monthSelector.innerHTML = '<option value="">اختر شهر</option>';
                    monthSelector.disabled = true;
                }
                fridaysGrid.innerHTML = '';
                activityButtons.classList.add('hidden-view');
                attendanceListContainer.classList.add('hidden-view');
            });

            monthSelector.addEventListener('change', () => {
                const year = parseInt(yearSelector.value);
                const month = parseInt(monthSelector.value);
                if (year && month >= 0) {
                    populateFridaysGrid(year, month);
                } else {
                    fridaysGrid.innerHTML = '';
                }
                activityButtons.classList.add('hidden-view');
                attendanceListContainer.classList.add('hidden-view');
            });

            fridaysGrid.addEventListener('click', (e) => {
                const button = e.target.closest('.friday-btn');
                if (button) {
                    document.querySelectorAll('.friday-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    selectedFriday = button.dataset.date;
                    updateActivityButtonsStatus(selectedFriday);
                    attendanceListContainer.classList.add('hidden-view');
                }
            });

            activityButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.activity-btn');
                if (button) {
                    const activity = button.dataset.activity;
                    if (selectedFriday) {
                        showActivityChecklist(activity, selectedFriday);
                    } else {
                        showMessage("الرجاء اختيار يوم الجمعة أولاً.", true);
                    }
                }
            });
            saveActivityAttendanceBtn.addEventListener('click', saveActivityAttendance);
            
            document.querySelectorAll('.report-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentReportType = tab.dataset.reportType;
                    reportOutput.classList.add('hidden-view');
                    if (currentReportType === 'individual') {
                        servantSelectorContainer.classList.remove('hidden-view');
                    } else {
                        servantSelectorContainer.classList.add('hidden-view');
                    }
                });
            });
            
            generateReportBtn.addEventListener('click', triggerReportGeneration);
            exportPngBtn.addEventListener('click', exportAsImage);
            exportPdfBtn.addEventListener('click', exportAsPdf);
            
            noActivityCheck.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                if (isChecked) {
                    noActivityReason.classList.remove('hidden');
                    servantsChecklist.classList.add('hidden');
                } else {
                    noActivityReason.classList.add('hidden');
                    servantsChecklist.classList.remove('hidden');
                }
            });

            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    closeModal(e.target.closest('.modal-backdrop'));
                    manualEntryForm.reset();
                    imagePreview.classList.add('hidden');
                    imagePreview.src = '';
                });
            });
            servicesGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.service-card');
                if (card) {
                    currentServiceName = card.dataset.serviceName;
                    document.getElementById('modalTitle').textContent = `الدخول إلى ${currentServiceName}`;
                    openModal(loginModal);
                    setTimeout(() => codeInput.focus(), 100);
                }
            });
            servantImageFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.src = event.target.result;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
    </script>
</body>
</html>
